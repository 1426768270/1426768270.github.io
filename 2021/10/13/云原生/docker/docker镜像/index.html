<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>docker镜像 | naive的博客</title><meta name="keywords" content="容器云,docker"><meta name="author" content="naive"><meta name="copyright" content="naive"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、什么是Docker镜像Docker镜像是一个只读的Docker容器模板，含有启动Docker容器所需的文件系统结构及其内容，是启动一个Docker容器的基础。Docker镜像的文件内容以及一些运行Docker容器的配置文件组成了Docker容器的静态文件系统运行环境―—rootfs。Docker镜像是Docker容器的静态视角，Docker容器是Docker镜像的运行状态。 rootfsroo">
<meta property="og:type" content="article">
<meta property="og:title" content="docker镜像">
<meta property="og:url" content="http://yoursite.com/2021/10/13/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E9%95%9C%E5%83%8F/index.html">
<meta property="og:site_name" content="naive的博客">
<meta property="og:description" content="一、什么是Docker镜像Docker镜像是一个只读的Docker容器模板，含有启动Docker容器所需的文件系统结构及其内容，是启动一个Docker容器的基础。Docker镜像的文件内容以及一些运行Docker容器的配置文件组成了Docker容器的静态文件系统运行环境―—rootfs。Docker镜像是Docker容器的静态视角，Docker容器是Docker镜像的运行状态。 rootfsroo">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/img/photo-1442522772768-9032b6d10e3e.jpg">
<meta property="article:published_time" content="2021-10-13T12:42:20.000Z">
<meta property="article:modified_time" content="2022-11-23T12:17:18.377Z">
<meta property="article:author" content="naive">
<meta property="article:tag" content="容器云">
<meta property="article:tag" content="docker">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/img/photo-1442522772768-9032b6d10e3e.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2021/10/13/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E9%95%9C%E5%83%8F/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: 'docker镜像',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2022-11-23 20:17:18'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="naive的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">174</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">44</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/photo-1442522772768-9032b6d10e3e.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">naive的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">docker镜像</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-13T12:42:20.000Z" title="发表于 2021-10-13 20:42:20">2021-10-13</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2022-11-23T12:17:18.377Z" title="更新于 2022-11-23 20:17:18">2022-11-23</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>22分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="docker镜像"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、什么是Docker镜像"><a href="#一、什么是Docker镜像" class="headerlink" title="一、什么是Docker镜像"></a>一、什么是Docker镜像</h2><p>Docker镜像是一个<strong>只读的Docker容器模板</strong>，含有启动Docker容器所需的文件系统结构及其内容，是启动一个Docker容器的基础。Docker镜像的<strong>文件内容以及一些运行Docker容器的配置文件</strong>组成了Docker容器的静态文件系统运行环境―—<code>rootfs</code>。Docker镜像是Docker容器的静态视角，Docker容器是Docker镜像的运行状态。</p>
<h3 id="rootfs"><a href="#rootfs" class="headerlink" title="rootfs"></a>rootfs</h3><p>rootfs是Docker容器在启动时内部进程可见的文件系统，即Docker容器的根目录。<strong>rootfs通常包含一个操作系统运行所需的文件系统</strong>，例如可能包含典型的类Unix操作系统中的目录系统，如/dev、/proc、/bin、/etc、/lib、/usr、/tmp及运行Docker容器所需的配置文件、工具等。</p>
<p>传统的Linux操作系统内核启动时，首先挂载一个<strong>只读( read-only)</strong>的rootfs，当系统检测其完整性之后，再将其切换为<strong>读写( read-write)</strong>模式。而在Docker架构中，当Docker daemon为Docker容器挂载rootfs时，沿用了Linux内核启动时的方法，即将rootfs设为只读模式。在挂载完毕之后，利用<strong>联合挂载( union mount)</strong>技术在已有的只读rootfs上再挂载一个读写层。这样，<strong>可读写层处于Docker容器文件系统的最顶层，其下可能联合挂载多个只读层</strong>，只有在Docker容器运行过程中文件系统发生变化时，才会把变化的文件内容写到可读写层，并隐藏只读层中的老版本文件。</p>
<h3 id="主要特点"><a href="#主要特点" class="headerlink" title="主要特点"></a>主要特点</h3><h4 id="分层"><a href="#分层" class="headerlink" title="分层"></a>分层</h4><p>Docker镜像是采用分层的方式构建的，每个镜像都由一系列的“镜像层”组成。分层结构是Docker镜像如此轻量的重要原因，当需要修改容器镜像内的某个文件时，<strong>只对处于最上方的读写层进行变动</strong>，不覆写下层已有文件系统的内容，已有文件在只读层中的原始版本仍然存在，但会<strong>被读写层中的新版文件所隐藏</strong>。当使用docker commit提交这个修改过的容器文件系统为一个新的镜像时，<strong>保存的内容仅为最上层读写文件系统中被更新过的文件</strong>。分层达到了<strong>在不同镜像之间共享镜像层的效果</strong>。</p>
<h4 id="写时复制"><a href="#写时复制" class="headerlink" title="写时复制"></a>写时复制</h4><p>Docker镜像使用了<strong>写时复制( copy-on-write）</strong>策略，在多个容器之间<strong>共享镜像</strong>，每个容器在启动的时候并不需要单独复制一份镜像文件，而是<strong>将所有镜像层以只读的方式挂载到一个挂载点</strong>，再在上面覆盖一个<strong>可读写的容器层</strong>。在未更改文件内容时，所有容器共享同一份数据，只有在Docker容器运行过程中文件系统发生变化时，才会把变化的文件内容写到可读写层，并隐藏只读层中的老版本文件。写时复制配合分层机制<strong>减少了镜像对磁盘空间的占用和容器启动时间。</strong></p>
<h4 id="内容寻址"><a href="#内容寻址" class="headerlink" title="内容寻址"></a>内容寻址</h4><ul>
<li>根据<strong>文件内容索引</strong>镜像和镜像层。</li>
<li>对镜像层的内容<strong>计算校验和</strong>，生成一个内容哈希值，作为唯一标识。</li>
<li>提高了镜像的安全性，在pull、push、load和save操作后<strong>检测数据的完整性。</strong></li>
<li>一定程度上减少了ID冲突并且增强了镜像共享。不同构建的镜像层，拥有相同内容哈希，也能被不同的镜像共享。</li>
</ul>
<h4 id="联合挂载"><a href="#联合挂载" class="headerlink" title="联合挂载"></a>联合挂载</h4><p><strong>联合文件系统</strong>。在一个挂载点挂载多个文件系统，将挂载点原目录和被挂载内容整合，最终可见的文件系统将会包含整合后的各层文件和目录。联合挂载是用于<strong>将多个镜像层的文件系统挂载到一个挂载点来实现一个统一文件系统视图</strong>的途径，是<strong>下层存储驱动(如aufs、overlay等）实现分层合并的方式</strong>。所以严格来说，联合挂载并不是Docker镜像的必需技术，比如我们在使用Device Mapper存储驱动时,其实是使用了快照技术来达到分层的效果，没有联合挂载这一概念。</p>
<h3 id="Docker镜像存储方式"><a href="#Docker镜像存储方式" class="headerlink" title="Docker镜像存储方式"></a>Docker镜像存储方式</h3><p>从图中我们可以看到，除了<code>echo hello</code>进程所在的<code>cgroups</code>和<code>namespace</code>环境之外，容器文件系统其实是一个<strong>相对独立的组织</strong>。<strong>可读写部分( read-write layer以及volumes )</strong>、<strong>init-layer</strong>、<strong>只读层( read-only layer)</strong>这3部分结构共同组成了一个容器所需的下层文件系统，它们通过联合挂载的方式巧妙地表现为一层，使得容器进程对这些层的存在一点都不知道。</p>
<p><img src="/2021/10/13/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E9%95%9C%E5%83%8F/docker%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F%E5%85%A8%E5%B1%80%E6%A6%82%E8%A7%88.png" alt="docker文件系统全局概览"></p>
<h2 id="二、Docker镜像关键概念"><a href="#二、Docker镜像关键概念" class="headerlink" title="二、Docker镜像关键概念"></a>二、Docker镜像关键概念</h2><h3 id="1-registry"><a href="#1-registry" class="headerlink" title="1.registry"></a>1.registry</h3><p>registry用以保存Docker镜像，其中还包括镜像层次结构和关于镜像的元数据。</p>
<p>用户可以在自己的数据中心搭建私有的registry，也可以使用Docker官方的公用registry服务，即<code>Docker Hub</code>。</p>
<h3 id="2-repository"><a href="#2-repository" class="headerlink" title="2.repository"></a>2.repository</h3><p>repository即由<strong>具有某个功能的Docker镜像的所有迭代版本构成的镜像组</strong>。registry由一系列经过命名的repository组成, repository通过命名规范对用户仓库和顶层仓库进行组织。用户仓库的命名由<strong>用户名和repository名两部分组成</strong>,中间以”/“隔开,即username/repository.name的形式，repository名通常表示镜像所具有的功能，如ansible/ubuntu14.04-ansible;而顶层仓库则只包含repository名的部分，如ubuntu。</p>
<h3 id="3-manifest"><a href="#3-manifest" class="headerlink" title="3.manifest"></a>3.manifest</h3><p><strong>manifest(描述文件</strong>）主要存在于registry中作为Docker镜像的<strong>元数据文件</strong>，在pull、push,save和load中作为镜像结构和基础信息的描述文件。在镜像被pull或者load到Docker宿主机时，manifest被转化为<strong>本地的镜像配置文件config</strong>。新版本（v2，schema 2 )的manifest list可以组合不同架构实现同名Docker镜像的manifest，用以支持多架构Docker镜像。</p>
<h3 id="4-image和layer"><a href="#4-image和layer" class="headerlink" title="4.image和layer"></a>4.image和layer</h3><p>Docker内部的<code>image</code>概念是用来存储一组镜像相关的元数据信息，主要包括<strong>镜像的架构（如amd64)、镜像默认配置信息、构建镜像的容器配置信息、包含所有镜像层信息的rootfs。</strong>Docker利用rootfs中的<code>diff_id</code>计算出内容寻址的索引 ( chainID)来获取layer相关信息，进而获取每一个镜像层的文件内容。<br><strong>layer(镜像层)</strong>是一个Docker用来管理镜像层的中间概念，前面提到镜像是由镜像层组成的，而单个镜像层可能被多个镜像共享，所以Docker将layer与image的概念分离。Docker镜像管理中的layer主要存放了镜像层的<strong>diff_id、size、cache-id和parent</strong>等内容，<strong>实际的文件内容则是由存储驱动来管理</strong>,并可以通过cache-id在本地索引到。</p>
<h2 id="三、Docker镜像的分发方法"><a href="#三、Docker镜像的分发方法" class="headerlink" title="三、Docker镜像的分发方法"></a>三、Docker镜像的分发方法</h2><p><code>docker push</code>和<code>docker pull</code>、或<code>docker save</code>和<code>docker load</code>命令进行分发。docker pull是通过Docker Hub的方式迁移，docker save是通过线下包分发的方式迁移。</p>
<p>对容器进行持久化和使用进行进行持久化区别：</p>
<ul>
<li><code>docker export</code>用于持久化<strong>容器</strong>，<code>docker push</code>和<code>docker save</code>用于持久化<strong>镜像</strong>。</li>
<li>将容器导出在导入（exported-imported）后的<strong>容器会丢失所有历史</strong>，而保存后在加载（saved-loaded）<strong>镜像没有丢失历史和层</strong>，后者可以通过docker tag实现历史层回滚。</li>
</ul>
<h3 id="docker-export导出容器"><a href="#docker-export导出容器" class="headerlink" title="docker export导出容器"></a>docker export导出容器</h3><p>Docker server接收到相应的HTTP请求后，会通过daemon实例调用<code>ContainerExport</code>方法来进行具体的操作，这个过程的主要步骤如下。</p>
<ol>
<li><p>根据命令行参数（容器名称）找到待导出的容器。</p>
</li>
<li><p>对该容器调用containerExport()函数导出容器中的所有数据，包括:</p>
<ul>
<li><p>挂载待导出容器的文件系统;</p>
</li>
<li><p>打包该容器<code>basefs</code> (即<code>graphdriver</code>上的挂载点)下的所有文件。以aufs为例，basefs对应的是<code>aufs/mnt</code>下对应容器ID的目录;</p>
</li>
<li><p>返回打包文档的结果并卸载该容器的文件系统。</p>
</li>
</ul>
</li>
<li><p>将导出的数据回写到HTTP请求应答中。</p>
</li>
</ol>
<h3 id="docker-save命令保存镜像"><a href="#docker-save命令保存镜像" class="headerlink" title="docker save命令保存镜像"></a>docker save命令保存镜像</h3><p>Docker client发来的请求由<code>getImagesGet Handler</code>进行处理，该Handler调用<code>ExportImage</code>函数进行具体的处理。</p>
<p><code>ExportImage</code>会根据imageStore、layerStore、referenceStore构建一个<code>imageExporter</code>，调用其<code>save</code>函数导出所有镜像。</p>
<p><code>save</code>函数负责查询到<strong>所有被要求export的镜像ID</strong>(（如果用户没有指定镜像标签，会指定默认标签latest)，并生成对应的镜像描述结构体。然后生成一个<code>saveSession</code>并调用其save函数来处理所有镜像的导出工作。<br>save函数会创建一个临时文件夹用于保存镜像json文件。然后<strong>循环遍历所有待导出的镜像</strong>，对每一个镜像执行<code>saveImage</code>函数来导出该镜像。另外，为了与老版本repository兼容，还会将被导出的<strong>repository的名称、标签及ID信息</strong>以JSON格式写入到名为<code>repositories</code>的文件中。而新版本中被导出的<strong>镜像配置文件名</strong>、<strong>repository的名称</strong>、<strong>标签以及镜像层描述信息</strong>则是写入到名为<code>manifest.json</code>的文件中。最后<strong>执行文件压缩</strong>并写入到输出流。</p>
<p><code>saveImage</code>函数首先根据镜像ID在imageStore中获取image结构体。其次是一个for循环，<strong>遍历该镜像RootFS中所有layer</strong>，对<strong>各个依赖layer进行export工作</strong>，即<strong>从顶层layer、其父layer及至baselayer</strong>：</p>
<ol>
<li>为每个<strong>被要求导出的镜像创建一个文件夹</strong>，以其镜像ID命名。</li>
<li>在该文件夹下<strong>创建VERSION文件</strong>，写入“1.0”。</li>
<li>在该文件夹下创建<code>json</code>文件，在该文件中写入镜像的<strong>元数据信息，包括镜像ID、父镜像ID以及对应的Docker容器ID</strong>等。</li>
<li>在该文件夹下创建<code>layer.tar</code>文件，<strong>压缩镜像的filesystem</strong>。该过程的核心函数为TarLayer<strong>,对存储镜像的diff路径中的文件进行打包。</strong></li>
<li>对该layer的父layer执行下一次循环。</li>
</ol>
<h2 id="四、Docker存储管理"><a href="#四、Docker存储管理" class="headerlink" title="四、Docker存储管理"></a>四、Docker存储管理</h2><h3 id="Docker镜像元数据管理"><a href="#Docker镜像元数据管理" class="headerlink" title="Docker镜像元数据管理"></a>Docker镜像元数据管理</h3><p>在设计上将镜像元数据与镜像文件的存储完全隔离开。在管理元数据时，采用从上到下<code>repository</code>、<code>image</code>、<code>layer</code>三个层次。由于Docker采用分层形式存储镜像，所以<code>repository</code>与<code>image</code>这两类元数据<strong>并无物理上的镜像文件</strong>与之对应，而layer这种元数据存在物理上的镜像层与之对应。</p>
<ol>
<li><p><strong>repository元数据</strong></p>
<p>repository在本地持久化文件存放与<code>/var/lib/docker/image/[some_graph_driver]/repositories.json</code>中</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">/var/lib/docker/image/aufs<span class="comment"># cat repositories.json | python -mjson.tool</span></span><br><span class="line"><span class="string">&quot;Repositories&quot;</span>: &#123;</span><br><span class="line">    <span class="string">&quot;busybox&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;busybox: latest&quot;</span> :</span><br><span class="line">       	<span class="string">&quot;sha256:47bcc53f74dc94b1920fob34f6036096526296767650f223433fe65c35f149eb&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;fedora&quot;</span> : &#123;</span><br><span class="line">    	<span class="string">&quot;fedora: latest&quot;</span> :</span><br><span class="line">    	<span class="string">&quot;sha256:ddd5c9c1dof2a08c5d53958a2590495d4f8a6166e2c1331380178af425ac9f3c&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;ubuntu&quot;</span> : &#123;</span><br><span class="line">        <span class="string">&quot;ubuntu: 14.04&quot;</span> :</span><br><span class="line">        	<span class="string">&quot;sha256:90d5884b1ee07f7f791f51bab92933943c87357bcd2fa6beoe82c48411bbb653&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文件存储了所有repository的名字、每个repository下所有<strong>版本镜像的名字以及对应的镜像ID。</strong>而<code>referenceStore</code>的作用是解析不同格式的repository名字，并管理repository与镜像ID的关系。</p>
</li>
<li><p><strong>image元数据</strong></p>
<p>包括镜像架构（如amd64）、操作系统（如Linux）、镜像默认配置、构建该镜像的容器ID、创建时间、创建该镜像的Docker版本、构建进行的历史信息以及rootfs组成。</p>
<p><strong>构建镜像的历史信息和rootfs</strong>组成部分除了具有描述镜像的作用外，还将镜像和构成该镜像的镜像层关联了起来。Docker会根据<strong>历史信息</strong>和rootfs中的<strong>diff_ids</strong>计算出<strong>构成该镜像的镜像层的存储索引chainID</strong>。</p>
<p><code>imageStore</code>则管理<strong>镜像ID与镜像元数据之间的映射关系以及元数据的持久化操作</strong>，持久化文件位于<code>/var/lib/docker/image/[graph_driver]/imagedb/content/sha256/[image_id]</code>中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat 7faaec68323851b2265bddb239bd9476c7d4e4335e9fd88cbfcc1df374dded2f </span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>我们重点来看看rootfs信息，docker inspect下这个image，可以看到有个<code>RootFS</code>项，里面记录了一些sha256 哈希值，这又是什么呢？</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[...</span><br><span class="line"><span class="string">&quot;RootFS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;Type&quot;</span>: <span class="string">&quot;layers&quot;</span>,</span><br><span class="line">            <span class="string">&quot;Layers&quot;</span>: [</span><br><span class="line">                <span class="string">&quot;sha256:e8b689711f21f9301c40bf2131ce1a1905c3aa09def1de5ec43cf0adf652576e&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:b43651130521eb89ffc3234909373dc42557557b3a6609b9fed183abaa0c4085&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:8b9770153666c1eef1bc685abfc407242d31e34f180ad0e36aff1a7feaeb3d9c&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:6b01cc47a390133785a4dd0d161de0cb333fe72e541d1618829353410c4facef&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:0bd13b42de4de0a0d0cc3f1f162cd0d4b8cb4ee20cbea7302164fdc6894955fd&quot;</span>,</span><br><span class="line">                <span class="string">&quot;sha256:146262eb38412d6eb44be1710bfe0f05d3493831f82b1c2be8dc8d9558c9f033&quot;</span></span><br><span class="line">            ]</span><br><span class="line">        &#125;,</span><br><span class="line">        </span><br><span class="line"> ...</span><br><span class="line"> ]</span><br></pre></td></tr></table></figure>

<p>后面的哈希值称为<code>diff_id</code>，其排列也是有顺序的，从上到下依次表示镜像层的最低层到最顶层。每层文件都存储<em>在</em><code>/var/lib/docker/overlay2/&lt;cache_id&gt;</code>目录下,docker 利用 <code>rootfs</code> 中的每个<code>diff_id</code> 和<strong>历史信息</strong>计算出与之对应的内容寻址的索引(<code>chainID</code>) ，而<code>chaiID</code>则关联了<code>cache_id</code>，进而关联到每一个镜像层的镜像文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">diff_id -&gt; chain_id -&gt; cache_id</span><br></pre></td></tr></table></figure>

<ul>
<li><p>cache_id: 可以在<code>/var/lib/docker/overlay2</code>中查看，也可以通过docker inpect 查看GraphDriver中的dir ID。</p>
</li>
<li><p>diff_id：通过docker inpect查看RootFS中的Layers项目</p>
</li>
<li><p>chain_id: 可以在<code>/var/lib/docker/image/overlay2/layerdb/sha256</code>查看</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#本例中</span></span><br><span class="line"><span class="comment"># layer_id有：</span></span><br><span class="line"><span class="comment"># ls /var/lib/docker/overlay2</span></span><br><span class="line">049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9</span><br><span class="line">0c11dee18f1e2556cec649be416d7b4221ddd6d224449b547ca983651edf4391</span><br><span class="line">35df5518615bb8c17558526dd1ce0ef2eab8d562129be3ec3b32831b1c41f827</span><br><span class="line">514dda44fa241d5bdc1cf5973a675161aebf77e7c47e9d20df0cb66a7fa8bf46</span><br><span class="line">93d168d9964b1a43c296b0dbc9caadefe079bccac58add92d07f883d16734610</span><br><span class="line">a20939fbb9a6e0bd5b185f293453748b67e89927b3ebad29a9e65acfbc684df4</span><br><span class="line">bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a</span><br><span class="line"></span><br><span class="line"><span class="comment"># diff_id有</span></span><br><span class="line"> <span class="string">&quot;sha256:e8b689711f21f9301c40bf2131ce1a1905c3aa09def1de5ec43cf0adf652576e&quot;</span>,            <span class="string">&quot;sha256:b43651130521eb89ffc3234909373dc42557557b3a6609b9fed183abaa0c4085&quot;</span>,            <span class="string">&quot;sha256:8b9770153666c1eef1bc685abfc407242d31e34f180ad0e36aff1a7feaeb3d9c&quot;</span>,            <span class="string">&quot;sha256:6b01cc47a390133785a4dd0d161de0cb333fe72e541d1618829353410c4facef&quot;</span>,</span><br><span class="line"> <span class="string">&quot;sha256:0bd13b42de4de0a0d0cc3f1f162cd0d4b8cb4ee20cbea7302164fdc6894955fd&quot;</span>,</span><br><span class="line"> <span class="string">&quot;sha256:146262eb38412d6eb44be1710bfe0f05d3493831f82b1c2be8dc8d9558c9f033&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># chain_id有</span></span><br><span class="line"><span class="comment"># ls /var/lib/docker/image/overlay2/layerdb/sha256</span></span><br><span class="line">l 24</span><br><span class="line">2649acad13241d9c8d81e49357bc66cce459b352ded7f423d70ede7bd3bb7b89</span><br><span class="line">64007bba5fc220df4d3da33cecdc2d55dd6a73528c138b0fa1acd79fd6a9c217</span><br><span class="line">b2cc2f1bf8b1cca8ba7c19e1697f7b73755903ad8f880b83673fd6a697aca935</span><br><span class="line">e6deb90762475cda72e21895911f830ed99fd1cc6d920d92873270be91235274</span><br><span class="line">e8b689711f21f9301c40bf2131ce1a1905c3aa09def1de5ec43cf0adf652576e</span><br><span class="line">fbd1283ab782925be4d990bd4bebe9ad5e5cf9a525abfb6fa87465e072da9d31</span><br></pre></td></tr></table></figure>



</li>
</ol>
<p>   从<strong>diff_id到chain_id</strong>的算法为：</p>
<ul>
<li><p>如果该镜像层是最底层(没有父镜像层)，该层的 diff_id 便是 chain_id。</p>
</li>
<li><p>该镜像层的 chain_id 计算公式为 <code>chainID=sha256(父层chain_id+&quot; &quot;+本层diff_id)</code>，也就是根据父镜像层的 chain_id 加上一个空格和当前层的 diff_id，再计算 SHA256 校验码。</p>
<blockquote>
<p><strong>layerID</strong>: 压缩数据的sha256的值 ，也就是pull一个镜像时的显示的id。</p>
<p><strong>diffID</strong>: 是 docker inspect 查看到的 镜像层 hash ID，此时 镜像层文件是解压缩的，解压缩态rootfs layers的值是diffID.<strong>distribution 目录</strong></p>
<ul>
<li><code>diffid-by-digest</code> 保存了<code>digest(layerID)-&gt;diffID</code>的映射关系</li>
<li><code>v2metadata-by-diffid</code> 保存了<code>diffid -&gt; (digest,repository)</code>的映射关系</li>
</ul>
<p><strong>chainID</strong>: <strong>layerdb/sha256</strong>下的目录名称是<strong>以layer的chainID来命名的</strong>,通过diffID计算而得。layerdb/sha256/目录下，存放着parent，size，<strong>cache-id</strong>，diff</p>
<p><strong>cache-id：存储驱动通过cache-id索引到layer的实际文件内容</strong></p>
</blockquote>
</li>
</ul>
<ol start="3">
<li><p><strong>layer元数据</strong></p>
<p>layer对应镜像层的概念，在Docker 1.10版本以前，镜像通过一个<code>graph</code>结构管理，每一个镜像层都拥有元数据，记录<strong>了该层的构建信息以及父镜像层ID</strong>，而<strong>最上面的镜像层会多记录一些信息作为整个镜像的元数据</strong>。graph则根据镜像ID（即最上层的镜像层ID)和每个镜像层记录的父镜像层ID维护了一个<strong>树状</strong>的镜像层结构。</p>
<p>在Docker 1.10版本后，镜像元数据管理巨大改变之一便是简化了镜像层的元数据，镜像层只包含一个<strong>具体的镜像层文件包</strong>。用户在Docker宿主机上下载了某个镜像层之后，Docker会在宿主机上基于镜像层文件包和image元数据，构建本地的layer元数据，包括<strong>diff、parent、size</strong>等。而将在宿主机上产生新的镜像层上传到registry时，与新镜像层相关的宿主机上的元数据也不会与镜像层一块打包上传。</p>
<p>Docker中定义了<code>Layer</code>和<code>RWLayper</code>两种接口，分别用来定义只读层和可读写层的一些操作，又定义了<code>roLayer</code>和<code>mountedLayer</code>，分别实现了上述两种接口。其中，<code>roLayer</code>用于描述不可改变的镜像层，<code>mountedLayer</code>用于描述可读写的容器层。</p>
<ul>
<li>roLayer 用于描述不可改变的镜像层，它的元数据位于 <code>/var/lib/docker/image/&lt;storage_driver&gt;/layerdb/sha256/&lt;chain_id&gt;</code></li>
<li>mountedLayer 用于描述可读写的容器层。它的元数据位于<code>/var/lib/docker/image/&lt;storage_driver&gt;/layerdb/mounts/&lt;container_id&gt;/</code></li>
</ul>
<p><code>roLayer</code>存储的内容主要有<strong>索引该镜像层的chainID</strong>、<strong>该镜像层的校验码diffID</strong>、<strong>父镜像层parent</strong>、<code>graphdriver</code>存储当前<strong>镜像层文件的cacheID</strong>、该<strong>镜像层的大小size</strong>等内容。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">tree -L 2</span><br><span class="line">.</span><br><span class="line">|-- 2649acad13241d9c8d81e49357bc66cce459b352ded7f423d70ede7bd3bb7b89</span><br><span class="line">|   |-- cache-id</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- parent</span><br><span class="line">|   |-- size</span><br><span class="line">|   `-- tar-split.json.gz</span><br><span class="line">|-- 64007bba5fc220df4d3da33cecdc2d55dd6a73528c138b0fa1acd79fd6a9c217</span><br><span class="line">|   |-- cache-id</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- parent</span><br><span class="line">|   |-- size</span><br><span class="line">|   `-- tar-split.json.gz</span><br><span class="line">|-- b2cc2f1bf8b1cca8ba7c19e1697f7b73755903ad8f880b83673fd6a697aca935</span><br><span class="line">|   |-- cache-id</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- parent</span><br><span class="line">|   |-- size</span><br><span class="line">|   `-- tar-split.json.gz</span><br><span class="line">|-- e6deb90762475cda72e21895911f830ed99fd1cc6d920d92873270be91235274</span><br><span class="line">|   |-- cache-id</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- parent</span><br><span class="line">|   |-- size</span><br><span class="line">|   `-- tar-split.json.gz</span><br><span class="line">|-- e8b689711f21f9301c40bf2131ce1a1905c3aa09def1de5ec43cf0adf652576e</span><br><span class="line">|   |-- cache-id</span><br><span class="line">|   |-- diff</span><br><span class="line">|   |-- size</span><br><span class="line">|   `-- tar-split.json.gz</span><br><span class="line">`-- fbd1283ab782925be4d990bd4bebe9ad5e5cf9a525abfb6fa87465e072da9d31</span><br><span class="line">    |-- cache-id</span><br><span class="line">    |-- diff</span><br><span class="line">    |-- parent</span><br><span class="line">    |-- size</span><br><span class="line">    `-- tar-split.json.gz</span><br><span class="line"></span><br><span class="line">6 directories, 29 files</span><br></pre></td></tr></table></figure>

<p>可以看到每个文件夹的名字都是<code>chain_id</code>，每个文件夹下面有5个文件，分别是：</p>
<ul>
<li><code>cache-id</code>：cache-id是docker下载layer的时候在本地生成的一个<strong>随机uuid</strong>，指向真正存放layer文件的地方。</li>
<li><code>diff</code>：文件存放layer的diff_id。</li>
<li><code>parent</code>：parent文件存放当前layer的父layer的<code>diff_id</code>，注意：对于最底层的layer来说，由于没有父layer，所以没有这个文件，例如本例子中的<code>e8b689711f21f9301c40bf2131ce1a1905c3aa09def1de5ec43cf0adf652576e</code> 。</li>
<li><code>size</code>：当前<strong>layer的大小</strong>，单位是字节。</li>
<li><code>tar-split.json.gz</code>：layer压缩包的split文件，通过这个文件可以还原layer的tar包，在docker save导出image的时候会用到</li>
</ul>
<p>通过<code>cat cache-id</code>就可以知道layer真正存放文件的位置。</p>
</li>
</ol>
<p>   <code>mountedLayer</code>存储的内容主要为索引某个容器的可读写层（也叫容器层）的<code>ID</code>(也对应容器的ID)</p>
<p>   查看该container的init层与容器层元数据</p>
   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /var/lib/docker/image/[graph_driver]/layerdb/mounts/[container_id]/</span><br><span class="line">ls</span><br><span class="line">init-id  mount-id  parent</span><br><span class="line">cat init-id</span><br><span class="line">bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a-init</span><br><span class="line">cat mount-id</span><br><span class="line">bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a</span><br><span class="line">cat parent</span><br><span class="line">sha256:e6deb90762475cda72e21895911f830ed99fd1cc6d920d92873270be91235274</span><br></pre></td></tr></table></figure>

<ul>
<li><code>mount-id</code>：存储在/var/lib/docker/overlay2/的目录名称。</li>
<li><code>init-id</code>：initID是在mountID后加了一个-init，同时initID就是存储在/var/lib/docker/overlay2/的目录名称。</li>
<li>parent：容器所基于的<strong>镜像的最上层的chain_id</strong>。（注意这个parent和roLayer元数据的parent的不同之处）。</li>
</ul>
<h2 id="五、存储驱动"><a href="#五、存储驱动" class="headerlink" title="五、存储驱动"></a>五、存储驱动</h2><p>Docker为了支持镜像分层和写时复制，Docker提供了存储驱动的接口。存储驱动根据操作系统的支持提供了针对某种文件系统的初始化操作和镜像层的<strong>增、删、改、查和差异比较</strong>。目前的接口有aufs、btrfs、devicemapper、vfs、overlay、zfs。vfs不支持写时复制，是为使用volume提供存储驱动，只做简单文件挂载操作。</p>
<p><strong>存储驱动的功能与管理</strong></p>
<p>Docker中管理文件系统的驱动为<code>graphdriver</code>。其中定义了统一的接口对不同的文件系统进行管理，在Docker daemon启动时就会根据不同的文件系统选择合适的驱动。</p>
<p><strong>常用的存储驱动overlay</strong></p>
<p>OverlayFS是一种新型联合文件系统，允许用户<strong>将一个文件系统与另一个文件系统重叠（overlay）</strong>,在上层的文件系统中记录更改，下层文件系保持不变。</p>
<p>主要使用4类目录完成工作：被联合挂载的两个目录<code>lower</code>和<code>upper</code>，作为统一视图联合挂载点的<code>merged</code>目录，作为辅助功能的<code>work</code>目录。</p>
<p>作为upper和lower被联合挂载的统一视图，当同一路径的文件分别存在于2个目录时，位于upper中的文件会屏蔽下层lower的文件夹，同文件夹的文件则会合并。OverlayFS会执行一个copy_up将文件从下层复制到上层.</p>
<h3 id="overlay2的目录结构"><a href="#overlay2的目录结构" class="headerlink" title="overlay2的目录结构"></a>overlay2的目录结构</h3><p>overlay2是上最新的Docker CE版本18.06.0上的默认存储驱动.</p>
<img src="/2021/10/13/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E9%95%9C%E5%83%8F/overlay2.jpg" alt="overlay2" style="zoom:80%;">

<p>通过redis镜像看<code>/var/lib/docker/overlay2</code></p>
<p><img src="/2021/10/13/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E9%95%9C%E5%83%8F/overlay2%E6%96%87%E4%BB%B6.png" alt="image-20211016133323087"></p>
<p>这个文件夹</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos l]<span class="comment"># ll</span></span><br><span class="line">total 32</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 23:08 CTDTMMF65E3BMSWDBORDZWNKMZ -&gt; ../bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a/diff</span><br><span class="line">lrwxrwxrwx 1 root root 77 Oct 15 23:08 EIFKNFA4XWG2Y23M42BB3UOAR3 -&gt; ../bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a-init/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 L6L4ECZTQI2TRRFXXFMG7IS4HJ -&gt; ../a20939fbb9a6e0bd5b185f293453748b67e89927b3ebad29a9e65acfbc684df4/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 LX6ZEQ54QRUVOVLE36C5Q4R3HL -&gt; ../049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 SMLOMKRFYWOKNGUBP5WDV3SRSP -&gt; ../93d168d9964b1a43c296b0dbc9caadefe079bccac58add92d07f883d16734610/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 YQCFTHN4NK637K6MG6JPWJLK2T -&gt; ../35df5518615bb8c17558526dd1ce0ef2eab8d562129be3ec3b32831b1c41f827/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 ZUO6UAVQPN3PQDP2LMW4DBLHAX -&gt; ../514dda44fa241d5bdc1cf5973a675161aebf77e7c47e9d20df0cb66a7fa8bf46/diff</span><br><span class="line">lrwxrwxrwx 1 root root 72 Oct 15 22:57 ZZK7WDD5HNYHP3PKBTF54O666R -&gt; ../0c11dee18f1e2556cec649be416d7b4221ddd6d224449b547ca983651edf4391/diff</span><br></pre></td></tr></table></figure>

<p>全部都是到各层<code>diff</code>之间的软链接，以<code>CTDTMMF65E3BMSWDBORDZWNKMZ</code>为例子，观察一下这个链接目录：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos l]<span class="comment"># cd CTDTMMF65E3BMSWDBORDZWNKMZ/</span></span><br><span class="line">[root@VM-4-9-centos CTDTMMF65E3BMSWDBORDZWNKMZ]<span class="comment"># ll</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 3 root root 4096 Oct 15 23:08 etc</span><br></pre></td></tr></table></figure>

<p>只有一个<code>etc</code>目录，<code>再查看EIFKNFA4XWG2Y23M42BB3UOAR3</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos EIFKNFA4XWG2Y23M42BB3UOAR3]<span class="comment"># ll</span></span><br><span class="line">total 8</span><br><span class="line">drwxr-xr-x 4 root root 4096 Oct 15 23:08 dev</span><br><span class="line">drwxr-xr-x 2 root root 4096 Oct 15 23:08 etc</span><br></pre></td></tr></table></figure>

<p>事实上，每层的<code>diff</code>即是文件系统在统一挂载时的挂载点，我们可以再进一步地<strong>观察最后一层</strong>，<code>ZZK7WDD5HNYHP3PKBTF54O666R</code>的内容：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 bin</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct  3 17:15 boot</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 dev</span><br><span class="line">drwxr-xr-x 30 root root 4096 Oct 11 08:00 etc</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct  3 17:15 home</span><br><span class="line">drwxr-xr-x  8 root root 4096 Oct 11 08:00 lib</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 lib64</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 media</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 mnt</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 opt</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct  3 17:15 proc</span><br><span class="line">drwx------  2 root root 4096 Oct 11 08:00 root</span><br><span class="line">drwxr-xr-x  3 root root 4096 Oct 11 08:00 run</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 sbin</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct 11 08:00 srv</span><br><span class="line">drwxr-xr-x  2 root root 4096 Oct  3 17:15 sys</span><br><span class="line">drwxrwxrwt  2 root root 4096 Oct 11 08:00 tmp</span><br><span class="line">drwxr-xr-x 11 root root 4096 Oct 11 08:00 usr</span><br><span class="line">drwxr-xr-x 11 root root 4096 Oct 11 08:00 var</span><br></pre></td></tr></table></figure>

<p>可以发现这一层仿佛就是一个Centos了,这些文件是只读的，每层具体的文件存放在层标识符下的<code>diff</code>目录下。</p>
<p>进入到第二个目录<code>0c11dee18f1e2556cec649be416d7b4221ddd6d224449b547ca983651edf4391</code>目录下。查看目录结构：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos 0c11dee18f1e2556cec649be416d7b4221ddd6d224449b547ca983651edf4391]<span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">|-- committed</span><br><span class="line">|-- diff</span><br><span class="line">|   |-- bin</span><br><span class="line">|   |-- boot</span><br><span class="line">|   |-- dev</span><br><span class="line">|   |-- etc</span><br><span class="line">|   |-- home</span><br><span class="line">|   |-- lib</span><br><span class="line">|   |-- lib64</span><br><span class="line">|   |-- media</span><br><span class="line">|   |-- mnt</span><br><span class="line">|   |-- opt</span><br><span class="line">|   |-- proc</span><br><span class="line">|   |-- root</span><br><span class="line">|   |-- run</span><br><span class="line">|   |-- sbin</span><br><span class="line">|   |-- srv</span><br><span class="line">|   |-- sys</span><br><span class="line">|   |-- tmp</span><br><span class="line">|   |-- usr</span><br><span class="line">|   `-- var</span><br><span class="line">`-- link</span><br><span class="line"></span><br><span class="line">20 directories, 2 files</span><br></pre></td></tr></table></figure>

<p>进入第一个目录<code>049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos 049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9]<span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">|-- committed</span><br><span class="line">|-- diff</span><br><span class="line">|   `-- data</span><br><span class="line">|-- link</span><br><span class="line">|-- lower</span><br><span class="line">`-- work</span><br><span class="line"></span><br><span class="line">[root@VM-4-9-centos 049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9]<span class="comment">#   </span></span><br><span class="line">cat lower </span><br><span class="line">l/ZUO6UAVQPN3PQDP2LMW4DBLHAX:l/YQCFTHN4NK637K6MG6JPWJLK2T:l/L6L4ECZTQI2TRRFXXFMG7IS4HJ:l/ZZK7WDD5HNYHP3PKBTF54O666R</span><br><span class="line">[root@VM-4-9-centos 049991c5c6099d5999c3d4c186cb3cc4ba568c31e6420fa72dff87d82b29fcb9]<span class="comment">#  </span></span><br><span class="line">cat link </span><br><span class="line">LX6ZEQ54QRUVOVLE36C5Q4R3HL</span><br></pre></td></tr></table></figure>

<p><code>link</code>文件描述了该层标识符的精简版，而<code>lower</code>文件描述了层序的组织关系。</p>
<p>启动一个容器，查看挂载情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount | grep overlay</span><br><span class="line">overlay on / <span class="built_in">type</span> overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/EIFKNFA4XWG2Y23M42BB3UOAR3:/var/lib/docker/overlay2/l/SMLOMKRFYWOKNGUBP5WDV3SRSP:/var/lib/docker/overlay2/l/LX6ZEQ54QRUVOVLE36C5Q4R3HL:/var/lib/docker/overlay2/l/ZUO6UAVQPN3PQDP2LMW4DBLHAX:/var/lib/docker/overlay2/l/YQCFTHN4NK637K6MG6JPWJLK2T:/var/lib/docker/overlay2/l/L6L4ECZTQI2TRRFXXFMG7IS4HJ:/var/lib/docker/overlay2/l/ZZK7WDD5HNYHP3PKBTF54O666R,upperdir=/var/lib/docker/overlay2/bf88c56ff03c6eee19d8a2ece7c69c3</span><br></pre></td></tr></table></figure>

<p>而在overlay2文件夹中会有2层：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">drwx--x--- 5 root root 4096 Oct 15 23:08 bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a</span><br><span class="line">drwx--x--- 4 root root 4096 Oct 15 23:08 bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a-init</span><br><span class="line"></span><br><span class="line"> CTDTMMF65E3BMSWDBORDZWNKMZ -&gt; ../bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a/diff</span><br><span class="line">lrwxrwxrwx 1 root root 77 Oct 15 23:08 EIFKNFA4XWG2Y23M42BB3UOAR3 -&gt; ../bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a-init/diff</span><br></pre></td></tr></table></figure>

<p>这一层是动态生成的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a-init]<span class="comment"># tree -L 2</span></span><br><span class="line">.</span><br><span class="line">|-- committed</span><br><span class="line">|-- diff</span><br><span class="line">|   |-- dev</span><br><span class="line">|   `-- etc</span><br><span class="line">|-- link</span><br><span class="line">|-- lower</span><br><span class="line">`-- work</span><br><span class="line">    `-- work</span><br><span class="line"></span><br><span class="line">5 directories, 3 files</span><br></pre></td></tr></table></figure>

<p>主要是一些配置文件构成的层。</p>
<p>而不带init后缀的：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.</span><br><span class="line">|-- diff</span><br><span class="line">|   |-- etc</span><br><span class="line">|   `-- root</span><br><span class="line">|-- link</span><br><span class="line">|-- lower</span><br><span class="line">|-- merged</span><br><span class="line">|   |-- bin</span><br><span class="line">|   |-- boot</span><br><span class="line">|   |-- data</span><br><span class="line">|   |-- dev</span><br><span class="line">|   |-- etc</span><br><span class="line">|   |-- home</span><br><span class="line">|   |-- lib</span><br><span class="line">|   |-- lib64</span><br><span class="line">|   |-- media</span><br><span class="line">|   |-- mnt</span><br><span class="line">|   |-- opt</span><br><span class="line">|   |-- proc</span><br><span class="line">|   |-- root</span><br><span class="line">|   |-- run</span><br><span class="line">|   |-- sbin</span><br><span class="line">|   |-- srv</span><br><span class="line">|   |-- sys</span><br><span class="line">|   |-- tmp</span><br><span class="line">|   |-- usr</span><br><span class="line">|   `-- var</span><br><span class="line">`-- work</span><br><span class="line">    `-- work</span><br><span class="line">    </span><br><span class="line">cat lower </span><br><span class="line">l/EIFKNFA4XWG2Y23M42BB3UOAR3:l/SMLOMKRFYWOKNGUBP5WDV3SRSP:l/LX6ZEQ54QRUVOVLE36C5Q4R3HL:l/ZUO6UAVQPN3PQDP2LMW4DBLHAX:l/YQCFTHN4NK637K6MG6JPWJLK2T:l/L6L4ECZTQI2TRRFXXFMG7IS4HJ:l/ZZK7WDD5HNYHP3PKBTF54O666R</span><br></pre></td></tr></table></figure>

<p>这个目录结构与与底层的centos相像，标识符多了一个文件夹<code>merged</code>，而与底层的<code>0c11dee18f1e2556cec649be416d7b4221ddd6d224449b547ca983651edf4391</code>，的<code>diff</code>文件夹相似，它正是容器的可读可写层。回头来观察overlay2联合挂载情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mount | grep overlay</span><br><span class="line">overlay on / <span class="built_in">type</span> overlay overlay on / <span class="built_in">type</span> overlay (rw,relatime,lowerdir=/var/lib/docker/overlay2/l/EIFKNFA4XWG2Y23M42BB3UOAR3:/var/lib/docker/overlay2/l/SMLOMKRFYWOKNGUBP5WDV3SRSP:/var/lib/docker/overlay2/l/LX6ZEQ54QRUVOVLE36C5Q4R3HL:/var/lib/docker/overlay2/l/ZUO6UAVQPN3PQDP2LMW4DBLHAX:/var/lib/docker/overlay2/l/YQCFTHN4NK637K6MG6JPWJLK2T:/var/lib/docker/overlay2/l/L6L4ECZTQI2TRRFXXFMG7IS4HJ:/var/lib/docker/overlay2/l/ZZK7WDD5HNYHP3PKBTF54O666R,upperdir=/var/lib/docker/overlay2/bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a/diff,workdir=/var/lib/docker/overlay2/bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a/work)</span><br></pre></td></tr></table></figure>

<p>overlay2将<code>lowerdir</code>、<code>upperdir</code>、<code>workdir</code>联合挂载，形成最终的<code>merged</code>挂载点，其中<code>lowerdir</code>是镜像只读层，<code>upperdir</code>是容器可读可写层，<code>workdir</code>是执行涉及修改<code>lowerdir</code>执行<code>copy_up</code>操作的中转层</p>
<p>在容器内创建一个文件：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@e96786091371:/data<span class="comment"># cat /root/hello </span></span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

<p>观测镜像的可读写层：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@VM-4-9-centos root]<span class="comment"># pwd</span></span><br><span class="line">/var/lib/docker/overlay2/bf88c56ff03c6eee19d8a2ece7c69c3d903b56350f4bef83d5ae5918143c320a/diff/root</span><br><span class="line">[root@VM-4-9-centos root]<span class="comment"># ll</span></span><br><span class="line">total 4</span><br><span class="line">-rw-r--r-- 1 root root 6 Oct 15 23:30 hello</span><br></pre></td></tr></table></figure>

<p>可以发现，新创建的文件被存在了可读写层，而此时如果我们通过以下命令：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker commit CONTAINER_ID</span><br></pre></td></tr></table></figure>

<p>提交容器更改，则会将该容器的当前可读可写层转化为只读层，更新镜像。镜像大体上，可以认为是多个只读层通过某些特定的方式组织起来，而容器则是在其之上的一个可读写层，我们可以保存一个可读写层的更改，将它转化为一个只读层。</p>
<h4 id="overlay2和overlay1的区别："><a href="#overlay2和overlay1的区别：" class="headerlink" title="overlay2和overlay1的区别："></a>overlay2和overlay1的区别：</h4><ol>
<li><p>overlay实际上通过<strong>硬链接在层和层之间共享文件</strong>，而<strong>overlay2的每一层都是完全独立</strong>的，通过每层的 <code>lower</code>文件。如果容器启动的话，它会将多层lowerdir 挂载到它的rootfs。</p>
<p>linux系统会限制系统中硬链接的数量，如果用户下载了很多容器，那么docker就会在系统中到处创建硬链接，达到最大值后将无法创建新容器。</p>
</li>
<li><p>overlay2中<code>link</code>文件描述了该层标识符的精简版，在overlay2每层的内容都是不一样的，<code>diff</code>是文件系统的<strong>统一挂载点</strong>,<code>link</code>文件描述的是<strong>该层的标识符</strong>，<code>lower</code>文件描述了<strong>层与层之间的组织关系</strong>，overlay2是将底层多个lowerdir和upperdir和workdir联合挂载，形成最终的merged挂载点。</p>
</li>
<li><p>overlay2为什么比overlay不消耗inode，根本原因在于那些文件夹，每层的root目录内存放的都是<strong>完整的rootfs文件夹</strong>，但它们都是新建出来的，它们inode都不一样，所以在overlay下一个容器镜像层数越多，占用的inode就越多。</p>
</li>
</ol>
<p>参考：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/robinunix/p/12157910.html">https://www.cnblogs.com/robinunix/p/12157910.html</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/41958018">https://zhuanlan.zhihu.com/p/41958018</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/374924046">https://zhuanlan.zhihu.com/p/374924046</a></p>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%B9%E5%99%A8%E4%BA%91/">容器云</a><a class="post-meta__tags" href="/tags/docker/">docker</a></div><div class="post_share"><div class="social-share" data-image="/./img/photo-1442522772768-9032b6d10e3e.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/10/16/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E6%95%B0%E6%8D%AE%E5%8D%B7/"><img class="prev-cover" src="/./img/photo-1626427832435-d6c500cc2686.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">docker数据卷</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/10/%E4%BA%91%E5%8E%9F%E7%94%9F/docker/docker%E8%B5%84%E6%BA%90%E9%99%90%E5%88%B6%E5%92%8C%E5%BA%95%E5%B1%82%E6%8A%80%E6%9C%AF/"><img class="next-cover" src="/./img/photo-1626811407568-2f41c53fff99.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">docker资源限制和底层技术</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/10/07/云原生/docker/docker基础/" title="docker基础"><img class="cover" src="/./img/photo-1465156799763-2c087c332922.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-07</div><div class="title">docker基础</div></div></a></div><div><a href="/2021/10/16/云原生/docker/docker日志和监控/" title="docker日志和监控"><img class="cover" src="/./img/photo-1626811407568-2f41c53fff99.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-16</div><div class="title">docker日志和监控</div></div></a></div><div><a href="/2021/10/10/云原生/docker/docker资源限制和底层技术/" title="docker资源限制和底层技术"><img class="cover" src="/./img/photo-1626811407568-2f41c53fff99.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-10</div><div class="title">docker资源限制和底层技术</div></div></a></div><div><a href="/2021/10/16/云原生/docker/docker数据卷/" title="docker数据卷"><img class="cover" src="/./img/photo-1626427832435-d6c500cc2686.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-16</div><div class="title">docker数据卷</div></div></a></div><div><a href="/2021/10/10/云原生/docker/docker网络/" title="docker网络"><img class="cover" src="/./img/photo-1626427832435-d6c500cc2686.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-10</div><div class="title">docker网络</div></div></a></div><div><a href="/2021/10/07/云原生/云原生/" title="云原生"><img class="cover" src="/./img/photo-1626427832435-d6c500cc2686.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-10-07</div><div class="title">云原生</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81%E4%BB%80%E4%B9%88%E6%98%AFDocker%E9%95%9C%E5%83%8F"><span class="toc-number">1.</span> <span class="toc-text">一、什么是Docker镜像</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#rootfs"><span class="toc-number">1.1.</span> <span class="toc-text">rootfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%BB%E8%A6%81%E7%89%B9%E7%82%B9"><span class="toc-number">1.2.</span> <span class="toc-text">主要特点</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%88%86%E5%B1%82"><span class="toc-number">1.2.1.</span> <span class="toc-text">分层</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%99%E6%97%B6%E5%A4%8D%E5%88%B6"><span class="toc-number">1.2.2.</span> <span class="toc-text">写时复制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%86%85%E5%AE%B9%E5%AF%BB%E5%9D%80"><span class="toc-number">1.2.3.</span> <span class="toc-text">内容寻址</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%81%94%E5%90%88%E6%8C%82%E8%BD%BD"><span class="toc-number">1.2.4.</span> <span class="toc-text">联合挂载</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E9%95%9C%E5%83%8F%E5%AD%98%E5%82%A8%E6%96%B9%E5%BC%8F"><span class="toc-number">1.3.</span> <span class="toc-text">Docker镜像存储方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Docker%E9%95%9C%E5%83%8F%E5%85%B3%E9%94%AE%E6%A6%82%E5%BF%B5"><span class="toc-number">2.</span> <span class="toc-text">二、Docker镜像关键概念</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-registry"><span class="toc-number">2.1.</span> <span class="toc-text">1.registry</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-repository"><span class="toc-number">2.2.</span> <span class="toc-text">2.repository</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-manifest"><span class="toc-number">2.3.</span> <span class="toc-text">3.manifest</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-image%E5%92%8Clayer"><span class="toc-number">2.4.</span> <span class="toc-text">4.image和layer</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81Docker%E9%95%9C%E5%83%8F%E7%9A%84%E5%88%86%E5%8F%91%E6%96%B9%E6%B3%95"><span class="toc-number">3.</span> <span class="toc-text">三、Docker镜像的分发方法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-export%E5%AF%BC%E5%87%BA%E5%AE%B9%E5%99%A8"><span class="toc-number">3.1.</span> <span class="toc-text">docker export导出容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#docker-save%E5%91%BD%E4%BB%A4%E4%BF%9D%E5%AD%98%E9%95%9C%E5%83%8F"><span class="toc-number">3.2.</span> <span class="toc-text">docker save命令保存镜像</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Docker%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86"><span class="toc-number">4.</span> <span class="toc-text">四、Docker存储管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Docker%E9%95%9C%E5%83%8F%E5%85%83%E6%95%B0%E6%8D%AE%E7%AE%A1%E7%90%86"><span class="toc-number">4.1.</span> <span class="toc-text">Docker镜像元数据管理</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81%E5%AD%98%E5%82%A8%E9%A9%B1%E5%8A%A8"><span class="toc-number">5.</span> <span class="toc-text">五、存储驱动</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#overlay2%E7%9A%84%E7%9B%AE%E5%BD%95%E7%BB%93%E6%9E%84"><span class="toc-number">5.1.</span> <span class="toc-text">overlay2的目录结构</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#overlay2%E5%92%8Coverlay1%E7%9A%84%E5%8C%BA%E5%88%AB%EF%BC%9A"><span class="toc-number">5.1.1.</span> <span class="toc-text">overlay2和overlay1的区别：</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2023 By naive</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>