<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>深入Pod | naive的博客</title><meta name="keywords" content="容器云,k8s"><meta name="author" content="naive"><meta name="copyright" content="naive"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一、Pod 定义详解pod的定义文件完整内容： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576apiVersion : vl kind: Pod metadat">
<meta property="og:type" content="article">
<meta property="og:title" content="深入Pod">
<meta property="og:url" content="http://yoursite.com/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/index.html">
<meta property="og:site_name" content="naive的博客">
<meta property="og:description" content="一、Pod 定义详解pod的定义文件完整内容： 12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505152535455565758596061626364656667686970717273747576apiVersion : vl kind: Pod metadat">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/img/photo-1465156799763-2c087c332922.jpg">
<meta property="article:published_time" content="2021-10-30T14:56:06.000Z">
<meta property="article:modified_time" content="2021-11-01T14:55:21.032Z">
<meta property="article:author" content="naive">
<meta property="article:tag" content="容器云">
<meta property="article:tag" content="k8s">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/img/photo-1465156799763-2c087c332922.jpg"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://yoursite.com/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"search.xml","languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: true,
    post: false
  },
  runtime: '天',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    jQuery: 'https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js',
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
    },
    fancybox: {
      js: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js',
      css: 'https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '深入Pod',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2021-11-01 22:55:21'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if (GLOBAL_CONFIG_SITE.isHome && /iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="naive的博客" type="application/atom+xml">
</head><body><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src="https://i.loli.net/2021/02/24/5O1day2nriDzjSu.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="site-data"><div class="data-item is-center"><div class="data-item-link"><a href="/archives/"><div class="headline">文章</div><div class="length-num">144</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/tags/"><div class="headline">标签</div><div class="length-num">42</div></a></div></div><div class="data-item is-center"><div class="data-item-link"><a href="/categories/"><div class="headline">分类</div><div class="length-num">19</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('/./img/photo-1465156799763-2c087c332922.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">naive的博客</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 主页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 文章</span></a></div><div class="menus_item"><a class="site-page" href="/tags/"><i class="fa-fw fa fa-tags"></i><span> 标签</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page" href="javascript:void(0);"><i class="fa-fw fas fa-list"></i><span> 链接</span><i class="fas fa-chevron-down expand"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></li><li><a class="site-page child" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></li></ul></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">深入Pod</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2021-10-30T14:56:06.000Z" title="发表于 2021-10-30 22:56:06">2021-10-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2021-11-01T14:55:21.032Z" title="更新于 2021-11-01 22:55:21">2021-11-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E4%BA%91%E5%8E%9F%E7%94%9F/">云原生</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">6.3k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>24分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="深入Pod"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="一、Pod-定义详解"><a href="#一、Pod-定义详解" class="headerlink" title="一、Pod 定义详解"></a>一、Pod 定义详解</h2><p>pod的定义文件完整内容：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion :</span> <span class="string">vl</span> </span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name :</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">namespace:</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">image :</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">imagePullPolicy:</span> [<span class="string">Always</span> <span class="string">|</span> <span class="string">Never</span> <span class="string">|</span> <span class="string">IfNotPresent</span>] </span><br><span class="line">    <span class="attr">command :</span> [<span class="string">string</span>] </span><br><span class="line">    <span class="attr">args:</span> [<span class="string">string</span>] </span><br><span class="line">    <span class="attr">workingDir:</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">volumeMounts:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">mountPath:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">readOnly:</span> <span class="string">boolean</span> </span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">containerPort:</span> <span class="string">int</span> </span><br><span class="line">      <span class="attr">hostPort :</span> <span class="string">int</span> </span><br><span class="line">      <span class="attr">protocol :</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">env:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">value :</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">resources :</span> </span><br><span class="line">      <span class="attr">limits:</span> </span><br><span class="line">        <span class="attr">cpu :</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">memory :</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">requests :</span> </span><br><span class="line">        <span class="attr">cpu:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">memory :</span> <span class="string">string</span></span><br><span class="line">    <span class="attr">livenessProbe:</span> </span><br><span class="line">      <span class="attr">exec:</span> </span><br><span class="line">        <span class="attr">command:</span> [<span class="string">string</span>] </span><br><span class="line">      <span class="attr">httpGet:</span> </span><br><span class="line">        <span class="attr">path:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">port:</span> <span class="string">number</span></span><br><span class="line">        <span class="attr">host:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">scheme:</span> <span class="string">string</span> </span><br><span class="line">        <span class="attr">httpHeaders:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">          <span class="attr">value:</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">tcpSocket:</span> </span><br><span class="line">        <span class="attr">port :</span> <span class="string">number</span> </span><br><span class="line">      <span class="attr">initialDelaySeconds :</span> <span class="number">0</span> </span><br><span class="line">      <span class="attr">timeoutSeconds:</span> <span class="number">0</span> </span><br><span class="line">      <span class="attr">periodSeconds:</span> <span class="number">0</span> </span><br><span class="line">      <span class="attr">successThreshold:</span> <span class="number">0</span>      </span><br><span class="line">      <span class="attr">failureThreshold :</span> <span class="number">0</span> </span><br><span class="line">    <span class="attr">securityContext :</span> </span><br><span class="line">      <span class="attr">privileged:</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">restartPolicy:</span> [<span class="string">Always</span> <span class="string">|</span> <span class="string">Never</span> <span class="string">|</span> <span class="string">OnFailure</span>] </span><br><span class="line"><span class="attr">nodeSelector:</span> <span class="string">object</span> </span><br><span class="line"><span class="attr">imagePullSecrets :</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line"><span class="attr">hostNetwork :</span> <span class="literal">false</span> </span><br><span class="line"><span class="attr">volumes:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name :</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">emptyDir :</span> &#123;&#125; </span><br><span class="line">  <span class="attr">hostPath :</span> </span><br><span class="line">    <span class="attr">path :</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">secret :</span> </span><br><span class="line">    <span class="attr">secretName :</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">items:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key :</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">path:</span> <span class="string">string</span> </span><br><span class="line">  <span class="attr">configMap:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">string</span> </span><br><span class="line">    <span class="attr">items :</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">key :</span> <span class="string">string</span> </span><br><span class="line">      <span class="attr">path:</span> <span class="string">string</span></span><br></pre></td></tr></table></figure>

<h2 id="二、Pod-的基本用法"><a href="#二、Pod-的基本用法" class="headerlink" title="二、Pod 的基本用法"></a>二、Pod 的基本用法</h2><h3 id="Pod的运行方式"><a href="#Pod的运行方式" class="headerlink" title="Pod的运行方式"></a>Pod的运行方式</h3><p>在使用 Docker 时，可以使用<code>docker run</code> 命令创建井启动一个容器。而在 Kubernetes 系统中对长时间运行容器的要求是：<strong>其主程序需要一直在前台执行</strong>。</p>
<p>如果我们创建的 Docker 镜像的启动命令是后台执行程序，例如 Linux 脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup . /start.sh &amp; </span><br></pre></td></tr></table></figure>

<p>则在 kubelet <strong>创建包含这个容器的 Pod 之后运行完该命令</strong>， <strong>即认为 Pod运行结束</strong>，<strong>将立刻销毁该Pod</strong> 。如果为该 Pod 定义了 <code>ReplicationController</code> ，则会监控到该 Pod 已经终止，根据RC定义的Pod的replicas副本数量生成一个新的Pod。这样会一直陷入循环。</p>
<p>对于前台执行的应用，可以使用开源工具 <code>Supervisor</code> 辅助进行前台运行的功能。 Supervisor 提供了一种可以同时启动多个后台应用，并保持 Supervisor 自身在前台执行的机制。</p>
<h3 id="Pod-对容器的封装和应用"><a href="#Pod-对容器的封装和应用" class="headerlink" title="Pod 对容器的封装和应用"></a>Pod 对容器的封装和应用</h3><p> Pod 可以由一个或多个容器组合而成。</p>
<p>名为台ontend Pod 只<strong>由一个容器组成</strong>:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">vl</span> </span><br><span class="line"><span class="attr">kind :</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">fr</span> <span class="string">ntend</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">frontend</span> </span><br><span class="line"><span class="attr">spec :</span> </span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">frontend</span></span><br><span class="line">    <span class="attr">imaqe:</span> <span class="string">kubequide/questbook-php-frontend</span> </span><br><span class="line">    <span class="attr">env :</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">GET_HOSTS_FROM</span> </span><br><span class="line">      <span class="attr">value :</span> <span class="string">env</span> </span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>



<p>当 frontend和redis 两个容器应用为紧辑合的关系，应该组合成一个整体对外提供服务时，应将这<strong>两个容器打包为一个 Pod</strong> ，</p>
<img src="/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/包含2个容器的Pod.png" alt="image-20211030232335693" style="zoom:80%;">

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion :</span> <span class="string">v</span> <span class="string">l</span> </span><br><span class="line"><span class="attr">kind :</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name :</span> <span class="string">redis-</span> <span class="string">php</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">name:</span> <span class="string">redis-</span> <span class="string">php</span> </span><br><span class="line"><span class="attr">spec :</span> </span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">frontend</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">kubequide/questbook-php-frontend:localredis</span></span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">redis</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">kubequide/redis-master</span> </span><br><span class="line">    <span class="attr">ports :</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p>属于一个 Pod 容器应用之间访问时<strong>仅需要通过 localhost 就可以通信</strong> ,使得这一组容器被绑定”在了一个环境。</p>
<h2 id="三、静态Pod"><a href="#三、静态Pod" class="headerlink" title="三、静态Pod"></a>三、静态Pod</h2><p>静态 Pod 是由<code>kubelet</code>进行管理的仅<strong>存在于特定 Node上的Pod</strong> 。<strong>不能</strong>通过 <code>API Server</code> 进行管理 ，无法与 <code>ReplicationController</code>、 Deployment 或者 <code>DaemonSet</code> 进行关联。井且 <code>kubelet</code>也无法对它 进行健康检查。</p>
<p>创建静态 Pod 有两种方式：配置文件方式和 HTTP方式</p>
<h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><p>设置 <code>kubelet</code> 的启动参数 <code>--config</code> ，指定 kubelet 需要监控的配置文件所在的目录， kubelet <strong>会定期扫描该目录</strong> 。并根据该目录中 <code>yaml</code>或<code>json</code> 进行 建操作。</p>
<p>假如配置目录为<code>/etc/kubelet.d/</code> 配置启动参数：<code>--config=/etc/kubelet.d/</code> 然后重启 kubelet 服务。然后在目录中放入需要启动的静态Pod的yaml文件，就会启动。</p>
<p>这个静态pod可以通过<code>kubectl get</code>获得查看，但是<strong>无法通Api Server直接管理</strong>，所以无法在Master节点删除，只会让Pod编程Pending状态。删除该Pod只能在节点配置目录下将yaml文件删除。</p>
<h3 id="HTTP"><a href="#HTTP" class="headerlink" title="HTTP"></a>HTTP</h3><p>设置 kubelet 的启动参数<code>--manifest-url</code> ， kubelet 将会定期从该 URL 地址下载 Pod定义文件，并以yaml /json 文件的格式进行解析，然后创建 Pod 。</p>
<h2 id="四、Pod容器共享Volume"><a href="#四、Pod容器共享Volume" class="headerlink" title="四、Pod容器共享Volume"></a>四、Pod容器共享Volume</h2><p>在同一个 Pod 中的多个容器能够共享 Po 级别的存储卷 Volume V</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Pod包含两个容器：tomcat busybox ,在 Pod级别设置 Volume &quot;app-logs&quot;用于 tomcat 向其中写日志文件， busybox读日志文件。</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">vl</span> </span><br><span class="line"><span class="attr">kind :</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">volume-pod</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">containers :</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">tomcat</span> </span><br><span class="line">    <span class="attr">image :</span> <span class="string">tomcat</span> </span><br><span class="line">    <span class="attr">ports :</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort :</span> <span class="number">8080</span> </span><br><span class="line">    <span class="attr">volumeMounts:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-logs</span> </span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/local/tomcat/logs</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">busybox</span> </span><br><span class="line">    <span class="attr">image :</span> <span class="string">busybox</span> </span><br><span class="line">    <span class="attr">command :</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;tail - f /logs/catalina*.log&quot;</span> ] </span><br><span class="line">    <span class="attr">volumeMounts:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-logs</span> </span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/logs</span> </span><br><span class="line">  <span class="attr">volumes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">app-logs</span></span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p>设置 Volume app-logs 类型 <code>emptyDir</code>, 挂载到 tomcat 器内的 <code>/usr/local/tomcat/logs</code>，同时挂载到 logreader容器 内的 logs 目录。tomcat 容器在启动后会<code>/usr/local/tomcat/logs</code> 目录 写文件， logreader器就可读取其中的文件了。</p>
<p>通过 <code>kubectl logs</code> 命令查看logreader 容器输出</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl logs volume-pod -c busybox</span><br></pre></td></tr></table></figure>

<h2 id="五、Pod-的配置管理"><a href="#五、Pod-的配置管理" class="headerlink" title="五、Pod 的配置管理"></a>五、Pod 的配置管理</h2><p><strong>将应用所需的配置信息与程序进行分离</strong>，使得应用程序被更好地复用，通过不同的配置也能实现更灵活的功能。可以通过环境变量或者外挂文件的方式在创建容器时进行配置注入。</p>
<p>ConfigMap就提供了统一的配置管理。</p>
<h3 id="1-ConfigMap概述"><a href="#1-ConfigMap概述" class="headerlink" title="1.ConfigMap概述"></a>1.ConfigMap概述</h3><ul>
<li>生成为容器内的<strong>环境变量</strong>。</li>
<li><strong>设置容器启动命令的启动参数</strong>（需设置为环境变量）。</li>
<li>以 Volume 的形式<strong>挂载为容器内部的文件或目录</strong>。</li>
</ul>
<p>ConfigMap 以一个或多个key:value的形式保存在 Kubernetes 系统中供应用使用，既可以用于<strong>表示一个变量的值</strong>，也可以用于<strong>表示一个完整配置文件的内容</strong>（例如server.xml =&lt;?xml… &gt; ) </p>
<p>以通过yaml 配置文件或者直接使用 <code>kubectl create configmap</code> 命令行的方式来创建 ConfigMap。</p>
<h3 id="2-创建ConfigMap资源对象"><a href="#2-创建ConfigMap资源对象" class="headerlink" title="2.创建ConfigMap资源对象"></a>2.创建ConfigMap资源对象</h3><h4 id="通过yaml配置文件创建"><a href="#通过yaml配置文件创建" class="headerlink" title="通过yaml配置文件创建"></a>通过yaml配置文件创建</h4><p>将几个应用所需的变量定义为ConfigMap:</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cm-appvars.yaml</span></span><br><span class="line"><span class="attr">apiVersion :</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata :</span></span><br><span class="line">  <span class="attr">name :</span> <span class="string">cm-appvars</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">apploglevel :</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">appdatadir:</span> <span class="string">/var/data</span></span><br></pre></td></tr></table></figure>

<p>使用ConfigMap</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建</span></span><br><span class="line">kubectl create -f cm-appvars.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">kubectl get configmap</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看详细信息</span></span><br><span class="line">kubectl describe configmap cm-appvars</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看yaml文件</span></span><br><span class="line">kubectl get configmap cm-appvars -o yaml</span><br></pre></td></tr></table></figure>

<p>将配置文件定义为configMap</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cm-appconfigfiles.yaml</span></span><br><span class="line"><span class="attr">apiVersion :</span> <span class="string">vl</span> </span><br><span class="line"><span class="attr">kind :</span> <span class="string">ConfigMap</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-appconfigfiles</span> </span><br><span class="line"><span class="attr">data :</span> </span><br><span class="line">  <span class="attr">key-serverxml :</span> <span class="string">...</span> <span class="comment">#tomcat的servervml全部文件</span></span><br><span class="line">  <span class="attr">key-loggingproperties :</span> <span class="string">...</span> <span class="comment">#配置文件</span></span><br></pre></td></tr></table></figure>

<h4 id="通过-kubectl-命令行方式创建"><a href="#通过-kubectl-命令行方式创建" class="headerlink" title="通过 kubectl 命令行方式创建"></a>通过 kubectl 命令行方式创建</h4><p>接通过 <code>kubectl create configmap</code> 也可以创建 ConfigMap ，可以使用参数<code>--from-file</code>或 <code>--from-literal</code> 指定内容，并且可以在一行命令中指定多个参数。</p>
<ol>
<li><p>通过<code>--from-file</code>，<strong>从文件中创建</strong>，可以指定 key 的名称，也可以 个命令行中创建包含多个 key的ConfigMap </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap NAME --from-file=[key=]<span class="built_in">source</span> --from-file=[key=]<span class="built_in">source</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>通过<code>--from-file</code> <strong>从目录中创建</strong>，该目录下的每个配置文件名都被设置为 key.</p>
<p>文件的内容被设置为 value </p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap NAME --from-file=config-files-dir</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>--from-literal</code> 从<strong>文本中创建建</strong>，直接将指定的 <code>key#=value#</code>创建为 ConfigMap的内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create configmap NAME --from-literal=keyl=valuel --from-literal=key2=value2</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>示例：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#当前目录下有配置文件 server.xml ，创建一个包含该文件内容的 ConfigMap：</span></span><br><span class="line">kubectl create confiqmap cm-server.xml --from-file=server.xml</span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">kubectl describe configmap cm-server.xml</span><br><span class="line"></span><br><span class="line"><span class="comment">#configfiles 目录下包含两个配置文件 server.xml logging.properties ，</span></span><br><span class="line">kubectl create configmap cm-appconf - -from-file=configfiles</span><br><span class="line">kubectl describe configmap cm-appconf</span><br><span class="line"></span><br><span class="line"><span class="comment">#使用--from-literal 参数进行创建</span></span><br><span class="line">kubectl create configmap cm-appenv --from-literal＝loglevel=info --from- literal=appdatadir=/var/data</span><br></pre></td></tr></table></figure>

<p>容器应用对configmap 的使用:</p>
<ul>
<li>通过环境变量获取 Config 中的内容。</li>
<li>通过 Volume 挂载的方式将ConfigMap 的内容挂载为容器内部的文件或目录。</li>
</ul>
<h3 id="3-Pod-申使用-ConfigMap"><a href="#3-Pod-申使用-ConfigMap" class="headerlink" title="3.Pod 申使用 ConfigMap"></a>3.Pod 申使用 ConfigMap</h3><h4 id="环境变方式使用-ConfigMap"><a href="#环境变方式使用-ConfigMap" class="headerlink" title="环境变方式使用 ConfigMap"></a>环境变方式使用 ConfigMap</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cm-configMap</span></span><br><span class="line"><span class="attr">apiVersion :</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata :</span></span><br><span class="line">  <span class="attr">name :</span> <span class="string">cm-appvars</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">apploglevel:</span> <span class="string">info</span></span><br><span class="line">  <span class="attr">appdatadir:</span> <span class="string">/var/data</span></span><br></pre></td></tr></table></figure>

<p>Pod <code>cm-test-pod</code>的定义中,将 <code>cm-appvars</code> 中的内容以环境变量(<code>APP LOG LEVEL</code> 和<code>APPDATADIR</code> ）设置为容器内部的环境变量，容器的启动命令将显示这两个环境变量的值（<code>env I grep APP</code>):</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span> </span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-test-pod</span> </span><br><span class="line"><span class="attr">spec :</span> </span><br><span class="line">  <span class="attr">containers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-test</span> </span><br><span class="line">    <span class="attr">image:</span> <span class="string">busybox</span> </span><br><span class="line">    <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;env | grep APP&quot;</span>] </span><br><span class="line">    <span class="attr">env:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APPLOGLEVEL</span>             <span class="comment"># 定义环境变量名称</span></span><br><span class="line">      <span class="attr">valueFrom:</span>                    <span class="comment"># key apploglevel 对应的值</span></span><br><span class="line">        <span class="attr">configMapKeyRef:</span> </span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-appvars</span>          <span class="comment"># 环境变量的值取自 cm-appvars 中：</span></span><br><span class="line">          <span class="attr">key:</span> <span class="string">apploglevel</span>          <span class="comment"># key为apploglevel</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">APPDATADIR</span>              <span class="comment"># 定义环境变量名称</span></span><br><span class="line">      <span class="attr">valueFrom:</span>                    <span class="comment"># key appdatadir 对应的值</span></span><br><span class="line">        <span class="attr">configMapKeyRef :</span> </span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-appvars</span>          <span class="comment"># 环境变量的值取自 cm-appvars中：</span></span><br><span class="line">          <span class="attr">key :</span> <span class="string">appdatadir</span>          <span class="comment"># key 为“appdatadir</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span>              <span class="comment"># 不会被系统重启</span></span><br></pre></td></tr></table></figure>

<p>创建</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cm-test-pod.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看己经停止的 Pod:</span></span><br><span class="line">kubectl get pods -A</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看该Pod的日志，可以看到启动命令飞&quot;env | grep APP&quot;执行结果</span></span><br><span class="line">kubectl logs cm-test-pod</span><br><span class="line">APPDATADIR=/var/data</span><br><span class="line">APPLOGLEVEL=info</span><br></pre></td></tr></table></figure>

<p>k8s1.6之后有一个新字段<code>envFrom</code>、实现在Pod环境将ConfigMap中定义的key=value自动生成为环境变量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-test-pod-envfrom</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test-container</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [ <span class="string">&quot;/bin/sh&quot;</span>, <span class="string">&quot;-c&quot;</span>, <span class="string">&quot;env&quot;</span> ]</span><br><span class="line">      <span class="attr">envFrom:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">configMapRef:</span></span><br><span class="line">          <span class="attr">name:</span> <span class="string">cm-appvars</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<h4 id="volumeMount使用ConfigMap"><a href="#volumeMount使用ConfigMap" class="headerlink" title="volumeMount使用ConfigMap"></a>volumeMount使用ConfigMap</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cm-configMap</span></span><br><span class="line"><span class="attr">apiVersion :</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">ConfigMap</span></span><br><span class="line"><span class="attr">metadata :</span></span><br><span class="line">  <span class="attr">name :</span> <span class="string">cm-serverxml</span></span><br><span class="line"><span class="attr">data:</span></span><br><span class="line">  <span class="attr">key-serverxml:</span> <span class="string">...</span></span><br><span class="line">  <span class="attr">key-loggingproperties:</span> <span class="string">...</span></span><br></pre></td></tr></table></figure>

<p>Pod <code>cm-test-app</code> 的定义中，将ConfigMap <code>cm-appconfigfiles</code> 中的内容以文件的形式mount 容器内部的／configfiles 录中去。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#cm-test-pod-volume</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">cm-test-pod-volume</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">cm-test-pod-volume</span></span><br><span class="line">      <span class="attr">image: kubeguide/tomcat-app:</span> <span class="string">vl</span></span><br><span class="line">      <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">8080</span></span><br><span class="line">      <span class="attr">volumeMounts :</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">serverxml</span>         <span class="comment">#引用 volume</span></span><br><span class="line">        <span class="attr">mountPath :</span> <span class="string">/configfiles</span> <span class="comment">#挂载到容器内的目录</span></span><br><span class="line">  <span class="attr">volumes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">serverxml</span>            <span class="comment">#定义volume</span></span><br><span class="line">    <span class="attr">configMap :</span> </span><br><span class="line">      <span class="attr">name :</span> <span class="string">cm-appconfigfiles</span> </span><br><span class="line">      <span class="attr">items:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">key-serverxml</span> <span class="comment"># key=key-serverxml </span></span><br><span class="line">        <span class="attr">path :</span> <span class="string">server.xml</span> <span class="comment"># value将server.xml 文件名进行挂载</span></span><br><span class="line">      <span class="bullet">-</span> <span class="attr">key:</span> <span class="string">key-loggingproperties</span> <span class="comment"># key=key-key-loggingpropertie</span></span><br><span class="line">        <span class="attr">path:</span> <span class="string">logging.properties</span> <span class="comment"># value logging.properties 文件名进行挂载</span></span><br></pre></td></tr></table></figure>

<p>创建Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f cm-test-pod-volume.yaml</span><br></pre></td></tr></table></figure>

<p>如果在使用时不值当items，则会为容器内的目录中为每一个item生成一个文件名为key的文件。</p>
<h3 id="4-使用-ConfigMap-的限制条件"><a href="#4-使用-ConfigMap-的限制条件" class="headerlink" title="4.使用 ConfigMap 的限制条件"></a>4.使用 ConfigMap 的限制条件</h3><ul>
<li><p>ConfigMap 必须<strong>在 Pod 之前创建</strong></p>
</li>
<li><p>ConfigMap Namespace 限制，只有<strong>处于相同 Namespaces 中的 Pod 可以引用它</strong></p>
</li>
<li><p>ConfigMap 中的<strong>配额管理还未能实现</strong></p>
</li>
<li><p>kubelet 只支持可以被 <code>API Server</code> 管理的 Pod 使用 ConfigMap,kubelet 在本 Node 上通</p>
<p>过<code>--manifest-url</code> 或<code>--config</code> 自动创建的<strong>静态Pod 将无法引用 ConfigMap</strong></p>
</li>
<li><p>Pod ConfigMap 进行挂载（ volumeMount ）操作时，容器内部<strong>只能挂载为“目录”</strong>，无法挂载为“文件”。在挂载到容器内部后，目录中将包含 ConfigMap 定义的每个 item,<strong>如果该目录下原来还有其他文件，则容器内的该目录将会被挂载的 ConfigMap 覆盖。</strong>可以将 ConfigMap<strong>挂载到容器内部的临时目录</strong>，再<strong>通过启动脚本将配置文件复制或者链接</strong>到（ link命令）应用所用的实际配置目录下。</p>
</li>
</ul>
<h2 id="六-容器内获取Pod信息"><a href="#六-容器内获取Pod信息" class="headerlink" title="六.容器内获取Pod信息"></a>六.容器内获取Pod信息</h2><p>Pod 在成功创建出来之后，都会被系统分配唯一的名字、IP地址， 井且处于某个 Nam space 中，如何在 Pod 容器内获取 Pod 这些重要信息呢？<code>Downward API</code>通过2种方式将Pod信息注入容器内部。</p>
<ul>
<li><strong>环境变量</strong>：用于单个变量，可以将 Pod 信息和 ontainer 信息注入容器内部。</li>
<li><strong>Volume 挂载</strong>：将数组类信息生成为文件，挂载到容器内部。</li>
</ul>
<h3 id="环境变量-将Pod信息注入为环境变量"><a href="#环境变量-将Pod信息注入为环境变量" class="headerlink" title="环境变量-将Pod信息注入为环境变量"></a>环境变量-将Pod信息注入为环境变量</h3><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dapi-test-pod-pod-vars.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod-pod-vars</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dapi-test-pod-pod-vars</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;/bin/sh&quot;</span>,<span class="string">&quot;-c&quot;</span>,<span class="string">&quot;env&quot;</span>] </span><br><span class="line">      <span class="attr">env:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_POD_NAME</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">fieldRef:</span> </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.name</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_POD_NAMESPACE</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">fieldRef:</span> </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.namespace</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_POD_IP</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">fieldRef :</span> </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">status.podIP</span>              </span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p><code>metadata.name</code>: Pod 名称，当 Pod 通过 RC 生成时，其名称是 RC 随机产生的唯一名称</p>
</li>
<li><p><code>status.podIP</code>: Pod 的回地址，之所以叫作 status.podIP 而非 metadata.IP 是因为 <strong>Pod</strong></p>
<p><strong>IP 属于状态数据</strong>，而非元数据</p>
</li>
<li><p><code>metadata.namespace</code>: Pod 所在的 Namespace</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dapi-test-pod-pod-vars.yaml</span><br><span class="line"></span><br><span class="line">kubectl logs dapi-test-pod-pod-vars</span><br><span class="line">...</span><br><span class="line">MY_POD_NAMESPACE=default</span><br><span class="line">MY_POD_IP=173.24.0.10</span><br><span class="line">MY_POD_NAME=dapi-test-pod-pod-vars</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<h3 id="环境变量-将容器资源信息注入为环境变量"><a href="#环境变量-将容器资源信息注入为环境变量" class="headerlink" title="环境变量-将容器资源信息注入为环境变量"></a>环境变量-将容器资源信息注入为环境变量</h3><p>通过 <code>Downward AP</code>I将Container 资源请求和 制信息注入容器环境变量中，容器应用使用 <code>printenv</code>命令印到标准输出中</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dapi-test-pod-container-vars.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span>  <span class="string">do</span> </span><br><span class="line">         <span class="string">echo</span> <span class="string">-en</span>  <span class="string">&#x27;\n&#x27;</span><span class="string">;</span></span><br><span class="line">         <span class="string">printenv</span> <span class="string">MY_CPU_REQUEST</span> <span class="string">MY_CPU_LIMIT;</span> </span><br><span class="line">         <span class="string">printenv</span> <span class="string">MY_MEM_REQUEST</span> <span class="string">MY_MEM_LIMIT;</span> </span><br><span class="line">         <span class="string">sleep</span> <span class="number">3600</span><span class="string">;</span></span><br><span class="line">        <span class="string">done;</span> </span><br><span class="line">      <span class="attr">resources:</span> </span><br><span class="line">        <span class="attr">requests:</span> </span><br><span class="line">          <span class="attr">memory :</span> <span class="string">&quot;32Mi&quot;</span></span><br><span class="line">          <span class="attr">cpu:</span> <span class="string">&quot;125m&quot;</span></span><br><span class="line">        <span class="attr">limits:</span> </span><br><span class="line">          <span class="attr">memory :</span> <span class="string">&quot;64Mi&quot;</span> </span><br><span class="line">          <span class="attr">cpu :</span> <span class="string">&quot;250m&quot;</span></span><br><span class="line">      <span class="attr">env:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_CPU_REQUEST</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">resourceFieldRef:</span> </span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line">              <span class="attr">resource :</span> <span class="string">requests.cpu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_CPU_LIMIT</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">resourceFieldRef:</span> </span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line">              <span class="attr">resource :</span> <span class="string">limits.cpu</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_MEM_REQUEST</span> </span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">resourceFieldRef:</span> </span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line">              <span class="attr">resource :</span> <span class="string">requests.memory</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">MY_MEM_LIMIT</span></span><br><span class="line">          <span class="attr">valueFrom:</span> </span><br><span class="line">            <span class="attr">resourceFieldRef:</span> </span><br><span class="line">              <span class="attr">containerName:</span> <span class="string">dapi-test-pod-container-vars</span></span><br><span class="line">              <span class="attr">resource :</span> <span class="string">limits.memory</span></span><br><span class="line">  <span class="attr">restartPolicy:</span> <span class="string">Never</span></span><br></pre></td></tr></table></figure>

<p>valueFrom 这种特殊的 Downward API 语法，目前 <code>resourceFieldRef</code> 可以将容器的资源请求和资源限制等配置设置为容器内部的环境变量。</p>
<ul>
<li><p><code>requests.cpu</code> ：容器的 CPU 请求值</p>
</li>
<li><p><code>limits.cpu</code> 容器的 CPU 限制值。</p>
</li>
<li><p><code>requests.memory</code> ：容器的内存请求值</p>
</li>
<li><p><code>limits.memory</code> ：容器的内存限制值</p>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">kubectl create -f dapi-test-pod-container-vars.yaml</span><br><span class="line"></span><br><span class="line">kubectl get pods</span><br><span class="line"></span><br><span class="line">kubectl logs dapi-test-pod-container-vars</span><br><span class="line">1</span><br><span class="line">1</span><br><span class="line">33554432</span><br><span class="line">67108864</span><br></pre></td></tr></table></figure>

<h3 id="Volume挂载方式"><a href="#Volume挂载方式" class="headerlink" title="Volume挂载方式"></a>Volume挂载方式</h3><p>通过 <code>Downward API</code> 将Pod的Label 、Annotation 表通过 Volume 挂载为容器内的个文件，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#dapi-test-pod-volume.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span></span><br><span class="line"><span class="attr">metadata:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">dapi-test-pod-volume</span></span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">zone:</span> <span class="string">us-est-coast</span></span><br><span class="line">    <span class="attr">cluster:</span> <span class="string">test-clusterl</span> </span><br><span class="line">    <span class="attr">rack :</span> <span class="string">rack-22</span></span><br><span class="line">  <span class="attr">annotations:</span></span><br><span class="line">    <span class="attr">build :</span> <span class="string">two</span></span><br><span class="line">    <span class="attr">builder:</span> <span class="string">john-doe</span></span><br><span class="line"><span class="attr">spec:</span></span><br><span class="line">  <span class="attr">containers:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">dapi-test-pod-volume</span></span><br><span class="line">      <span class="attr">image:</span> <span class="string">busybox</span></span><br><span class="line">      <span class="attr">imagePullPolicy:</span> <span class="string">Never</span></span><br><span class="line">      <span class="attr">command:</span> [<span class="string">&quot;sh&quot;</span>,<span class="string">&quot;-c&quot;</span>]</span><br><span class="line">      <span class="attr">args:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="string">while</span> <span class="literal">true</span><span class="string">;</span>  <span class="string">do</span> </span><br><span class="line">         <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/home/lq/labels</span> ]] <span class="string">;</span> <span class="string">then</span> </span><br><span class="line">           <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/home/lq/labels;</span> <span class="string">fi;</span> </span><br><span class="line">         <span class="string">if</span> [[ <span class="string">-e</span> <span class="string">/home/lq/annotations</span> ]] <span class="string">;</span> <span class="string">then</span> </span><br><span class="line">           <span class="string">echo</span> <span class="string">-en</span> <span class="string">&#x27;\n\n&#x27;</span><span class="string">;</span> <span class="string">cat</span> <span class="string">/home/lq/annotations;</span> <span class="string">fi</span> <span class="string">;</span> </span><br><span class="line">         <span class="string">sleep</span> <span class="number">3600</span><span class="string">;</span></span><br><span class="line">        <span class="string">done;</span> </span><br><span class="line">      <span class="attr">volumeMounts:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span> </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/home/lq</span> </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span> </span><br><span class="line">  <span class="attr">volumes:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">podinfo</span></span><br><span class="line">      <span class="attr">downwardAPI:</span></span><br><span class="line">        <span class="attr">items:</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;labels&quot;</span>   </span><br><span class="line">            <span class="attr">fieldRef :</span></span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.labels</span> </span><br><span class="line">          <span class="bullet">-</span> <span class="attr">path:</span> <span class="string">&quot;annotations&quot;</span></span><br><span class="line">            <span class="attr">fieldRef :</span> </span><br><span class="line">              <span class="attr">fieldPath:</span> <span class="string">metadata.annotations</span></span><br></pre></td></tr></table></figure>

<p>通过 items 设置，将会 <strong>path 的名称生成文件</strong>。这里将在容器内生成 <code>/etc/ labels</code> 和<code>/etc/annotations</code> 两个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建</span></span><br><span class="line">kubectl create -f dapi-test-pod-volume.yaml </span><br><span class="line">kubectl get pods</span><br><span class="line">kubectl logs dapi-test-pod-volume</span><br><span class="line"></span><br><span class="line">cluster=<span class="string">&quot;test-clusterl&quot;</span></span><br><span class="line">rack=<span class="string">&quot;rack-22&quot;</span></span><br><span class="line">zone=<span class="string">&quot;us-est-coast&quot;</span></span><br><span class="line"></span><br><span class="line">build=<span class="string">&quot;two&quot;</span></span><br><span class="line">builder=<span class="string">&quot;john-doe&quot;</span></span><br><span class="line">kubernetes.io/config.seen=<span class="string">&quot;2021-10-31T20:15:49.597569984+08:00&quot;</span></span><br></pre></td></tr></table></figure>

<p>Downward API作用：</p>
<p>集群中，每个节点都需要将<strong>自身的标识（ ID ）及进程绑定的 IP 地址等信息事先写入配置文件</strong>中 ，进程启动时读取这些信息，然后<strong>发布到某个类似服务注册中心</strong>的地方，以实现集群节点的自动发现功能。先编写个预启动脚本或 <code>Init Container</code> ，通过环境变量或文件方式<strong>获取 Pod 自身的名称 IP 地址等信息，然后写入主程序的配置文件中 最后启动主程序</strong>。</p>
<h2 id="七、Pod生命周期和重启策略"><a href="#七、Pod生命周期和重启策略" class="headerlink" title="七、Pod生命周期和重启策略"></a>七、Pod生命周期和重启策略</h2><p>Pod状态表</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>Pending</td>
<td>API Server 己经创建该 Pod ，Pod 内<strong>还有个或多个容器的镜像没有创建</strong>，包括正在下镜像的过程</td>
</tr>
<tr>
<td>Running</td>
<td>Pod <strong>所有容器均己创建</strong>，且至少有一个容器处于运行状态、正在启动状态或正在重启状态</td>
</tr>
<tr>
<td>Succeeded</td>
<td>Pod 内所有容器<strong>均成功执行退出</strong> 且不会再重启</td>
</tr>
<tr>
<td>Failed</td>
<td>Pod 所有容器均已退出，但<strong>至少有一个容器退出为失败状态</strong></td>
</tr>
<tr>
<td>Unknown</td>
<td>由于某种原因<strong>无法获取该 Pod 的状态</strong> 可能由于网络通信不畅导致</td>
</tr>
</tbody></table>
<p>Pod <strong>重启策略（ RestartPolicy ）</strong>应用于 Pod 内的所有容器，井且仅在 Pod 所处的 Node，kubelet 进行判断和重启操作。当当某个容器异常退出或者健康检查失败时， kubelet将根据 <code>RestartPolicy</code> 设置来进行相应的操作</p>
<ul>
<li><code>Always</code> 当容器失效时，由 kubelet 动重启该容器。默认策略</li>
<li><code>OnFailure</code> 当容器终止运行且退出码不为0时，由 kubelet 自动重启该容器。</li>
<li><code>Never</code> 不论容器运行状态如何， kubelet 都不会重启该容器。</li>
</ul>
<p>kubelet 重启失效容器的时间间隔以 <code>sync-frequency</code> 乘以 2n 来计算；例如1,2,4,8 倍等，最长延时 5min ，并且在成功重启后的 10min 后重置该时间。</p>
<p>Pod <strong>重启策略与控制方式息息相关</strong>，当前可用于管理 Pod 的控制器包括<code>ReplicationController</code>、 <code>Job</code>、<code>DaemonSet</code> 及直接通过 kubelet 管理（静态 Pod ）。每种控制器对 Pod的重启策略要求如下。</p>
<ul>
<li><code>RC</code>、<code>Daemon Set</code> ：必须设置为 Always ，需要保证该容器持续运行。</li>
<li><code>Job</code>: OnFailure或Never ，<strong>确保容器执行完成后不再重启。</strong></li>
<li><code>kubelet</code> ：<strong>Pod 失效时自动重启它</strong>，不论将 RestartPolicy 设置为什么值，也不会对 Pod进行健康检查。</li>
</ul>
<h2 id="八、Pod健康检查"><a href="#八、Pod健康检查" class="headerlink" title="八、Pod健康检查"></a>八、Pod健康检查</h2><p>通过两类探针检查：<code>LivenessProbe</code> 和<code>ReadinessProbe</code></p>
<ul>
<li><code>LivenessProbe</code> 探针：于<strong>判断容器是否存活（running 状态）</strong>，如果 <code>LivenessProbe</code> 探针探测到容器不健康，则 <strong>kubelet 将杀掉该容器</strong>，并根据容器的重启策略做相应的处理。如果 个容器不包含 <code>LivenessProbe</code> 探针，那么 kubelet 认为该容器的 LivenessProbe针返回的值永远是“ Success”</li>
<li><code>ReadinessProbe</code> 探针：于<strong>判断容器是否启动完成（ ready 状态）</strong>，可以接收请求。如果<code>ReadinessProbe</code> 探针检测到失败，则 Pod 的状态将被修改。 <code>Endpoint Controller</code> 将从Service Endpoint 中删除包含该容器所在 Pod Endpoint</li>
</ul>
<h2 id="九、Pod-调度"><a href="#九、Pod-调度" class="headerlink" title="九、Pod 调度"></a>九、Pod 调度</h2><p>Pod 在大部分场景下都只是容器的载体而己，通常需要通过<code>Deployment</code>、<code>DaemonSet</code> 、<code>Job</code> 等对象来完成一组 Pod 的调度与自动控制功能。</p>
<h3 id="1-Deployment-RC-全自动调度"><a href="#1-Deployment-RC-全自动调度" class="headerlink" title="1.Deployment/RC 全自动调度"></a>1.Deployment/RC 全自动调度</h3><p>自动部署一个容器应用的多份副本，以及持续监控副本数量在集群内始终维持用户指定的副本量。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#nginx-deployment.yaml </span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx-deployment</span></span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">3</span> </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">nginx-app</span></span><br><span class="line">  <span class="attr">template:</span> </span><br><span class="line">    <span class="attr">metadata :</span> </span><br><span class="line">      <span class="attr">labels:</span> </span><br><span class="line">        <span class="attr">app:</span> <span class="string">nginx-app</span> </span><br><span class="line">    <span class="attr">spec :</span> </span><br><span class="line">      <span class="attr">containers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">nginx:1.7.9</span> </span><br><span class="line">        <span class="attr">ports:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">containerPort :</span> <span class="number">80</span></span><br></pre></td></tr></table></figure>

<p>使用：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建</span></span><br><span class="line">kubectl create -f nginx-deployment.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看 Deployment 状态</span></span><br><span class="line">NAME               READY   UP-TO-DATE   AVAILABLE   AGE</span><br><span class="line">nginx-deployment   3/3     3            3           8m39s</span><br><span class="line"></span><br><span class="line">kubectl get rs</span><br><span class="line">NAME                         DESIRED   CURRENT   READY   AGE</span><br><span class="line">nginx-deployment-f75bf47d    3         3         3       3m43s</span><br><span class="line"></span><br><span class="line">kubectl get pods</span><br></pre></td></tr></table></figure>

<p>调度策略上来说 Nginx Pod 由系统全自动调度。它们各自最终运行在哪个节点上完全由 Master Scheduler 一系列算法算得 ，用户无法干预调度过程和结果。</p>
<h3 id="2-NodeSelector定向调度"><a href="#2-NodeSelector定向调度" class="headerlink" title="2. NodeSelector定向调度"></a>2. NodeSelector定向调度</h3><p>实际情况中，也可能需要将 Pod 度到指定的一些 Node 上，可以通过 Node 的标签(Label) Pod的<code>nodeSelector</code> 属性相匹配实现定向调度。</p>
<ol>
<li><p>对节点打标签</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">kubectl label nodes &lt;node-name&gt; &lt;label-key&gt;=&lt;label-value&gt;</span><br><span class="line">kubectl label nodes master role=master</span><br><span class="line"></span><br><span class="line">kubectl  get node --show-labels=<span class="literal">true</span></span><br><span class="line">NAME     STATUS   ROLES                  AGE     VERSION   LABELS</span><br><span class="line">master   Ready    control-plane,master   7d23h   v1.20.9   beta.kubernetes.io/arch=amd64,beta.kubernetes.io/os=linux,kubernetes.io/arch=amd64,kubernetes.io/hostname=master,kubernetes.io/os=linux,node-role.kubernetes.io/control-plane=,node-role.kubernetes.io/master=,role=master</span><br></pre></td></tr></table></figure>
</li>
<li><p>在 Pod 定义中 <code>nodeSelector</code> 的设置</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis-master-controller.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Deployment</span> </span><br><span class="line"><span class="attr">metadata :</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">redis-master-deployment</span></span><br><span class="line"><span class="attr">spec:</span>  </span><br><span class="line">  <span class="attr">replicas:</span> <span class="number">1</span> </span><br><span class="line">  <span class="attr">selector:</span> </span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">app:</span> <span class="string">redis-master-deployment</span> </span><br><span class="line">  <span class="attr">template:</span> </span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">labels:</span> </span><br><span class="line">        <span class="attr">app:</span>  <span class="string">redis-master-deployment</span> </span><br><span class="line">    <span class="attr">spec :</span> </span><br><span class="line">      <span class="attr">nodeSelector:</span>           <span class="comment">#这个Pod运行在role=master的节点上</span></span><br><span class="line">        <span class="attr">role:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">containers :</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">master</span> </span><br><span class="line">        <span class="attr">image:</span> <span class="string">kubeguide/redis-master</span> </span><br><span class="line">        <span class="attr">ports :</span></span><br><span class="line">        <span class="bullet">-</span>  <span class="attr">containerPort :</span> <span class="number">6379</span></span><br></pre></td></tr></table></figure>

<p><code>kubectl create -f</code> 命令 Pod</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#查看pod所在节点</span></span><br><span class="line">kubectl get pods -o wide</span><br><span class="line">redis-master-deployment-5445bf9f7c-227tw   1/1     Running     0          118s    173.24.0.22   master   &lt;none&gt;           &lt;none&gt;</span><br></pre></td></tr></table></figure>

<p>如果给多个Node 定义了相同的标签（例如 key=master ），则<code>scheduler</code>将会根据调度算法从这组 Node 中选出一个可用 Node 进行 Pod 调度。</p>
</li>
</ol>
<p><strong>通过给集群不同Node贴不同标签，就可以在部署应用时根据应用的需求设置NodeSelector进行指定Node范围的选取</strong>。</p>
<blockquote>
<p>如果我指定了 <code>Pod nodeSelector</code> 条件，且集群中不存在包含相应标签Node则即使集群中还有其他可供使用的 Node ，这个 Pod 也无法被成功调度</p>
</blockquote>
<p><code>Node Selector</code> 通过标签 方式 简单 实现了限制 Pod 所在节点的方法。亲和性调度机制极大地扩展了 Pod 调度能力，主要功能如下:</p>
<ul>
<li>可以<strong>使用软限制 、优先采用等限制方式代替之前的硬限制</strong>，这样调度器在无法满足优先需求的情况下，会退而求其次，继续运行该 Pod</li>
<li>依据节点上<strong>正在运行 Pod 的标签来进行限制</strong>，而非节点本身的标签这样就可<strong>以定义一种规 来描述 Pod 之间的亲和或互斥关系</strong></li>
</ul>
<p>亲和性调度功能包括<strong>节点亲和性（NodeAffmity ）</strong>和 <strong>Pod 亲和 （PodAffinity ）</strong>两个维度的设置。节点亲和性与 NodeSelector 类似，增强了上述前两点的优势； <strong>Pod 的亲和与互斥限制则通过 Pod 标签而不是节点标签来实现</strong></p>
<h3 id="3-NodeAffinity-Node亲和性调度"><a href="#3-NodeAffinity-Node亲和性调度" class="headerlink" title="3.NodeAffinity: Node亲和性调度"></a>3.NodeAffinity: Node亲和性调度</h3><p>Node 亲和性的调度策略</p>
<ul>
<li><code>RequiredDuringSchedulinglgnoredDuringExecution</code> ：必须满足指定的规则才可以调度 Pod到Node 上（功能与 nodeSelector 很像，但是使用的是不同的语法），相当于硬限制。</li>
<li><code>PreferredDuringSchedulinglgnoredDuringExecution</code> ：强调优先满足指定规则，调度器尝试调度 Pod到Node ，但并不强求，相当于软限制 。多个优先级规则还可以设置权重（ weight ）值，以定义执行的先后顺序。</li>
</ul>
<p><code>IgnoredDuringExecution</code> 意思是：如果 Pod 所在的节点在 Pod 运行期间标签发生了变更，不再符合该 Pod 节点亲和性需求，<strong>则系统将忽略 Node Label 的变化，该 Pod 能继续在该节点运行。</strong></p>
<h3 id="4-DaemonSet-在每个-Node-上调度一个-Pod"><a href="#4-DaemonSet-在每个-Node-上调度一个-Pod" class="headerlink" title="4.DaemonSet:在每个 Node 上调度一个 Pod"></a>4.DaemonSet:在每个 Node 上调度一个 Pod</h3><p>于管理在集群中每个 Node仅运行一份 Pod 的副本实例</p>
<img src="/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/DaemonSet.png" alt="image-20211031224554504" style="zoom:67%;">

<p>适合一些有这种需求的应用。</p>
<ul>
<li>在每个 Node 上运行一个 <strong>GlusterFS 存储或者 Ceph 存储</strong>的 Daemon 进程。</li>
<li>在每个 Node 上运行一个<strong>日志采集程序</strong>，例如 Fluentd 或者 Logstach</li>
<li>在每个 Node 上运行一个<strong>性能监控程序</strong>，采集该 Node 的运行性能数据，例如 Prometheus、Node Exporter 、collectd 、New Relic agent 或者 Ganglia gmond 等。</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#fluentd-ds.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">apps/v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">DaemonSet</span>                        <span class="comment">#声明</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">fluentd-cloud-logging</span></span><br><span class="line">  <span class="attr">namespace :</span> <span class="string">kube-system</span> </span><br><span class="line">  <span class="attr">labels:</span> </span><br><span class="line">    <span class="attr">k8s-app:</span> <span class="string">fluentd-cloud-logging</span></span><br><span class="line"><span class="attr">spec :</span> </span><br><span class="line">  <span class="attr">selector:</span></span><br><span class="line">    <span class="attr">matchLabels:</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">fluentd-cloud-logging</span></span><br><span class="line">  <span class="attr">template:</span> </span><br><span class="line">    <span class="attr">metadata:</span> </span><br><span class="line">      <span class="attr">namespace :</span> <span class="string">kube-system</span> </span><br><span class="line">      <span class="attr">labels:</span> </span><br><span class="line">        <span class="attr">name:</span> <span class="string">fluentd-cloud-logging</span>    <span class="comment">#这里是name</span></span><br><span class="line">    <span class="attr">spec:</span> </span><br><span class="line">      <span class="attr">containers:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">fluentd-cloud-logging</span></span><br><span class="line">        <span class="comment">#image: gcr.io/google_containers/fluentd-elasticsearch:1.17</span></span><br><span class="line">        <span class="comment">#docker pull mirrorgooglecontainers/fluentd-elasticsearch:v2.0.1</span></span><br><span class="line">        <span class="attr">image:</span> <span class="string">mirrorgooglecontainers/fluentd-elasticsearch:v2.0.1</span></span><br><span class="line">        <span class="attr">resources :</span> </span><br><span class="line">          <span class="attr">limits :</span> </span><br><span class="line">            <span class="attr">cpu:</span> <span class="string">100m</span> </span><br><span class="line">            <span class="attr">memory :</span> <span class="string">200Mi</span></span><br><span class="line">        <span class="attr">env:</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">FLUENTD_ARGS</span> </span><br><span class="line">          <span class="attr">value:</span> <span class="string">-q</span> </span><br><span class="line">        <span class="attr">volumeMounts :</span> </span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">varlog</span></span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/log</span></span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containers</span> </span><br><span class="line">          <span class="attr">mountPath:</span> <span class="string">/var/lib/docker/containers</span> </span><br><span class="line">          <span class="attr">readOnly:</span> <span class="literal">false</span></span><br><span class="line">      <span class="attr">volumes:</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">containers</span>                 <span class="comment">#挂载物理机两个目录</span></span><br><span class="line">        <span class="attr">hostPath:</span> </span><br><span class="line">          <span class="attr">path :</span> <span class="string">/var/lib/docker/containers</span> </span><br><span class="line">      <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">varlog</span> </span><br><span class="line">        <span class="attr">hostPath:</span> </span><br><span class="line">          <span class="attr">path :</span> <span class="string">/var/log</span></span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建</span></span><br><span class="line">kubectl create -f fluentd-ds.yaml</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看</span></span><br><span class="line">kubectl get daemonset --namespace=kube-system</span><br></pre></td></tr></table></figure>

<h3 id="5-Job：批处理调度"><a href="#5-Job：批处理调度" class="headerlink" title="5.Job：批处理调度"></a>5.Job：批处理调度</h3><p>批处理任务通常并行（ 串行）启动多批计算进程去处理一批<strong>工作项（ work item</strong> ），处理完成后 整个批处任务结束。几种模式：</p>
<ul>
<li><code>Job Template Expansion</code> 模式：一个 Job 应对应一个待处理的<code>Work item</code> ，有 几个<code>Work item</code> 就产生几个独立 Job ，<strong>通常适合 Work item 数量少 、每个 Work item 要处理的数据量比较大的场景</strong>， 如有一个 100GB的文件作为一个 <code>Work item</code>， 总共 10 文件需要处理。</li>
<li><code>Queue with Pod Per Work Item</code> 模式 ：一个 队列任务存放 <code>Work item</code> ，一个 Job 对象作为消费者去完成这些 Work item, <strong>Job 会启动 Pod ，Job启动N个Pod,每个 Pod对应一个<code>Work item</code></strong></li>
<li><code>Queue with Variable Pod Count</code> 模式：也是采用一个任务队列存放 <code>Work item</code>，一个 Job对象作为消费者去完成这些 <code>Work item</code> 但与上面模式不同， Job 启动 Pod 数量是可变的。</li>
</ul>
<img src="/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/批处理任务的几种模式.png" alt="image-20211101215523706" style="zoom:67%;">

<h2 id="十、Init-Container-初始化容器"><a href="#十、Init-Container-初始化容器" class="headerlink" title="十、Init Container 初始化容器"></a>十、Init Container 初始化容器</h2><p>在很多应用场景中、应用在启动之前都需要进行初始化操作</p>
<ul>
<li>等待<strong>其他关联组件正确运行</strong>（例如数据库）</li>
<li>基于<strong>环境变量或配置模板生成配置文件</strong>。</li>
<li>从<strong>远程数据库获取本地所需配置</strong>，或者将自身注册到某个中央数据库中。</li>
<li>下载相关依赖包 或者对系统进行一些预配置操作。</li>
</ul>
<p>于在启动<strong>应用容器（ app container ）</strong>之前启动一个或多个“初始 ”容器，完成应用容器所需的预置条件。<code>Init container</code> 与应用容器本质上是一样的 但它们是仅运行 次就结束的任务，并且必须在成功执行完成后，系统才能继续运行下一个容器。</p>
<img src="/2021/10/30/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/%E6%B7%B1%E5%85%A5Pod/initcontainer.png" alt="image-20211101223118602" style="zoom: 80%;">

<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#在启动 Nginx 之前，通过初始化容器 busybox Nginx 创建inde.html 主页文件。为 ini container Nginx 设置了一个共享的 volume ，以供 Nginx 访问init container 设置的 index.html 文件</span></span><br><span class="line"><span class="comment">#nginx-init-containers.yaml</span></span><br><span class="line"><span class="attr">apiVersion:</span> <span class="string">v1</span></span><br><span class="line"><span class="attr">kind:</span> <span class="string">Pod</span>                        <span class="comment">#声明</span></span><br><span class="line"><span class="attr">metadata:</span> </span><br><span class="line">  <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">annotations:</span> </span><br><span class="line"><span class="attr">spec:</span> </span><br><span class="line">  <span class="comment"># These containers are run during pod nit al zat on</span></span><br><span class="line">  <span class="attr">initContainers:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">install</span> </span><br><span class="line">    <span class="attr">image :</span> <span class="string">busybox</span> </span><br><span class="line">    <span class="attr">command:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">wget</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;-O&quot;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&quot;/work-dir/index.html&quot;</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="string">http://kubernetes.io</span> </span><br><span class="line">    <span class="attr">volumeMounts :</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">workdir</span> </span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">&quot;/work-dir&quot;</span></span><br><span class="line">  <span class="attr">containers :</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">nginx</span></span><br><span class="line">    <span class="attr">image:</span> <span class="string">nginx</span> </span><br><span class="line">    <span class="attr">ports:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">containerPort:</span> <span class="number">80</span> </span><br><span class="line">    <span class="attr">volumeMounts:</span> </span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">workdir</span> </span><br><span class="line">      <span class="attr">mountPath:</span> <span class="string">/usr/share/nginx/html</span> </span><br><span class="line">  <span class="attr">dnsPolicy:</span> <span class="string">Default</span> </span><br><span class="line">  <span class="attr">volumes :</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name :</span> <span class="string">workdir</span> </span><br><span class="line">    <span class="attr">emptyDir:</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<p><code>init container</code>与应用容器的区别：</p>
<ul>
<li><p>运行方式不同，<strong>先于应用容器执行完成</strong>，当设置了多个init container时，将按顺序逐个运行，前一个initcontainer运行成功之后才能运行下一个。</p>
</li>
<li><p><code>init container</code> 的定义中也可以设置资源限制、 volume 的使用和安全策略 </p>
<ul>
<li>果多个 init container 都定义了资源请求／资源限制，则取最大的值作为所有 <code>init container</code> 的资源请求值／资源限制值</li>
<li>Pod 的<strong>有效（ effective ）资源请求值／资源限制值</strong>取以下二者中的较大值<ul>
<li>所有应用容器的资源请求值／资源限制值之和</li>
<li>in it container 的有效资源请求值／资源限制值</li>
</ul>
</li>
<li>调度算法将基于 Pod 的有效资源请求值／资源限制值进行计算，也就是说 init container <strong>可以为初始化操作预留系统资源，即使后续应用容器无须使用这些资源。</strong></li>
<li>Pod 的有效 QoS 等级适用于 init container 和应用容器</li>
<li>资源配额和限制将根据 Pod 的有效资源请求值／资源限制值计算生效。</li>
<li>Pod 级别的 cgroup 将基于 Pod 的有效资源请求／限制，与调度机制 致。</li>
</ul>
</li>
<li><p><code>init container</code> 不能设置 <code>readinessProbe</code> 探针，因为必须在它们成功运行后才能继续运行Pod 中定义的普通容器</p>
<p>Pod 重新启动（ Restart ）时 init container 将会重新运行，常见的 Pod 重启场最如下。</p>
<ul>
<li>i<strong>nit container 的镜像被更新时</strong>， init container 将会重新运行，导致 Pod 重启。<strong>仅更新应用容器的镜像只会使得应用容器被重启。</strong></li>
<li>Pod的infrastructure 容器（pause ）更新时， Pod 将会重启。</li>
<li>Pod 中的所有应用容器都终止了，并且 RestartPolicy=Always ，则 Pod 将会重启</li>
</ul>
</li>
</ul>
</article><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%AE%B9%E5%99%A8%E4%BA%91/">容器云</a><a class="post-meta__tags" href="/tags/k8s/">k8s</a></div><div class="post_share"><div class="social-share" data-image="/./img/photo-1465156799763-2c087c332922.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/11/01/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/Pod%E5%8D%87%E7%BA%A7%E5%92%8C%E5%9B%9E%E6%BB%9A/"><img class="prev-cover" src="/./img/photo-1628009193228-076ab63d655a.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Pod升级和回滚</div></div></a></div><div class="next-post pull-right"><a href="/2021/10/24/%E4%BA%91%E5%8E%9F%E7%94%9F/kubernetes/k8s%E5%9F%BA%E6%9C%AC%E6%A6%82%E5%BF%B5%E5%92%8C%E6%9C%AF%E8%AF%AD/"><img class="next-cover" src="/./img/photo-1465156799763-2c087c332922.jpg" onerror="onerror=null;src='/img/404.jpg'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Kubernetes基本概念和术语</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span> 相关推荐</span></div><div class="relatedPosts-list"><div><a href="/2021/11/07/云原生/kubernetes/ControllerManager/" title="Controller Manager"><img class="cover" src="/./img/photo-1443891238287-325a8fddd0f7.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-07</div><div class="title">Controller Manager</div></div></a></div><div><a href="/2021/11/07/云原生/kubernetes/KubernetesAPIServer/" title="Kubernetes API SERVER"><img class="cover" src="/./img/photo-1626277787644-47d530591292.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-07</div><div class="title">Kubernetes API SERVER</div></div></a></div><div><a href="/2021/11/01/云原生/kubernetes/Pod升级和回滚/" title="Pod升级和回滚"><img class="cover" src="/./img/photo-1628009193228-076ab63d655a.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-01</div><div class="title">Pod升级和回滚</div></div></a></div><div><a href="/2021/11/02/云原生/kubernetes/Pod扩容和缩容/" title="Pod扩容和缩容"><img class="cover" src="/./img/photo-1628009193228-076ab63d655a.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-02</div><div class="title">Pod扩容和缩容</div></div></a></div><div><a href="/2021/11/08/云原生/kubernetes/Scheduler原理/" title="Scheduler原理"><img class="cover" src="/./img/photo-1442522772768-9032b6d10e3e.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-11-08</div><div class="title">Scheduler原理</div></div></a></div><div><a href="/2021/08/23/云原生/kubernetes/k8s中的副本控制器/" title="k8s中的副本控制器"><img class="cover" src="/./img/photo-1465188162913-8fb5709d6d57.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2021-08-23</div><div class="title">k8s中的副本控制器</div></div></a></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E3%80%81Pod-%E5%AE%9A%E4%B9%89%E8%AF%A6%E8%A7%A3"><span class="toc-number">1.</span> <span class="toc-text">一、Pod 定义详解</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C%E3%80%81Pod-%E7%9A%84%E5%9F%BA%E6%9C%AC%E7%94%A8%E6%B3%95"><span class="toc-number">2.</span> <span class="toc-text">二、Pod 的基本用法</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod%E7%9A%84%E8%BF%90%E8%A1%8C%E6%96%B9%E5%BC%8F"><span class="toc-number">2.1.</span> <span class="toc-text">Pod的运行方式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod-%E5%AF%B9%E5%AE%B9%E5%99%A8%E7%9A%84%E5%B0%81%E8%A3%85%E5%92%8C%E5%BA%94%E7%94%A8"><span class="toc-number">2.2.</span> <span class="toc-text">Pod 对容器的封装和应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89%E3%80%81%E9%9D%99%E6%80%81Pod"><span class="toc-number">3.</span> <span class="toc-text">三、静态Pod</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6"><span class="toc-number">3.1.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HTTP"><span class="toc-number">3.2.</span> <span class="toc-text">HTTP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B%E3%80%81Pod%E5%AE%B9%E5%99%A8%E5%85%B1%E4%BA%ABVolume"><span class="toc-number">4.</span> <span class="toc-text">四、Pod容器共享Volume</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94%E3%80%81Pod-%E7%9A%84%E9%85%8D%E7%BD%AE%E7%AE%A1%E7%90%86"><span class="toc-number">5.</span> <span class="toc-text">五、Pod 的配置管理</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-ConfigMap%E6%A6%82%E8%BF%B0"><span class="toc-number">5.1.</span> <span class="toc-text">1.ConfigMap概述</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E5%88%9B%E5%BB%BAConfigMap%E8%B5%84%E6%BA%90%E5%AF%B9%E8%B1%A1"><span class="toc-number">5.2.</span> <span class="toc-text">2.创建ConfigMap资源对象</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87yaml%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">5.2.1.</span> <span class="toc-text">通过yaml配置文件创建</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%9A%E8%BF%87-kubectl-%E5%91%BD%E4%BB%A4%E8%A1%8C%E6%96%B9%E5%BC%8F%E5%88%9B%E5%BB%BA"><span class="toc-number">5.2.2.</span> <span class="toc-text">通过 kubectl 命令行方式创建</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-Pod-%E7%94%B3%E4%BD%BF%E7%94%A8-ConfigMap"><span class="toc-number">5.3.</span> <span class="toc-text">3.Pod 申使用 ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E6%96%B9%E5%BC%8F%E4%BD%BF%E7%94%A8-ConfigMap"><span class="toc-number">5.3.1.</span> <span class="toc-text">环境变方式使用 ConfigMap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#volumeMount%E4%BD%BF%E7%94%A8ConfigMap"><span class="toc-number">5.3.2.</span> <span class="toc-text">volumeMount使用ConfigMap</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E4%BD%BF%E7%94%A8-ConfigMap-%E7%9A%84%E9%99%90%E5%88%B6%E6%9D%A1%E4%BB%B6"><span class="toc-number">5.4.</span> <span class="toc-text">4.使用 ConfigMap 的限制条件</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AD-%E5%AE%B9%E5%99%A8%E5%86%85%E8%8E%B7%E5%8F%96Pod%E4%BF%A1%E6%81%AF"><span class="toc-number">6.</span> <span class="toc-text">六.容器内获取Pod信息</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-%E5%B0%86Pod%E4%BF%A1%E6%81%AF%E6%B3%A8%E5%85%A5%E4%B8%BA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">6.1.</span> <span class="toc-text">环境变量-将Pod信息注入为环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F-%E5%B0%86%E5%AE%B9%E5%99%A8%E8%B5%84%E6%BA%90%E4%BF%A1%E6%81%AF%E6%B3%A8%E5%85%A5%E4%B8%BA%E7%8E%AF%E5%A2%83%E5%8F%98%E9%87%8F"><span class="toc-number">6.2.</span> <span class="toc-text">环境变量-将容器资源信息注入为环境变量</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Volume%E6%8C%82%E8%BD%BD%E6%96%B9%E5%BC%8F"><span class="toc-number">6.3.</span> <span class="toc-text">Volume挂载方式</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%83%E3%80%81Pod%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F%E5%92%8C%E9%87%8D%E5%90%AF%E7%AD%96%E7%95%A5"><span class="toc-number">7.</span> <span class="toc-text">七、Pod生命周期和重启策略</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%85%AB%E3%80%81Pod%E5%81%A5%E5%BA%B7%E6%A3%80%E6%9F%A5"><span class="toc-number">8.</span> <span class="toc-text">八、Pod健康检查</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B9%9D%E3%80%81Pod-%E8%B0%83%E5%BA%A6"><span class="toc-number">9.</span> <span class="toc-text">九、Pod 调度</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-Deployment-RC-%E5%85%A8%E8%87%AA%E5%8A%A8%E8%B0%83%E5%BA%A6"><span class="toc-number">9.1.</span> <span class="toc-text">1.Deployment&#x2F;RC 全自动调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-NodeSelector%E5%AE%9A%E5%90%91%E8%B0%83%E5%BA%A6"><span class="toc-number">9.2.</span> <span class="toc-text">2. NodeSelector定向调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-NodeAffinity-Node%E4%BA%B2%E5%92%8C%E6%80%A7%E8%B0%83%E5%BA%A6"><span class="toc-number">9.3.</span> <span class="toc-text">3.NodeAffinity: Node亲和性调度</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-DaemonSet-%E5%9C%A8%E6%AF%8F%E4%B8%AA-Node-%E4%B8%8A%E8%B0%83%E5%BA%A6%E4%B8%80%E4%B8%AA-Pod"><span class="toc-number">9.4.</span> <span class="toc-text">4.DaemonSet:在每个 Node 上调度一个 Pod</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-Job%EF%BC%9A%E6%89%B9%E5%A4%84%E7%90%86%E8%B0%83%E5%BA%A6"><span class="toc-number">9.5.</span> <span class="toc-text">5.Job：批处理调度</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8D%81%E3%80%81Init-Container-%E5%88%9D%E5%A7%8B%E5%8C%96%E5%AE%B9%E5%99%A8"><span class="toc-number">10.</span> <span class="toc-text">十、Init Container 初始化容器</span></a></li></ol></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2022 By naive</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div><div class="footer_custom_text">Hi, welcome to my <a target="_blank" rel="noopener" href="https://butterfly.js.org/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><div class="search-dialog__title" id="local-search-title">本地搜索</div><div id="local-input-panel"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div></div><hr/><div id="local-search-results"></div><span class="search-close-button"><i class="fas fa-times"></i></span></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module"></script><script>function panguFn () {
  if (typeof pangu === 'object') pangu.autoSpacingPage()
  else {
    getScript('https://cdn.jsdelivr.net/npm/pangu/dist/browser/pangu.min.js')
      .then(() => {
        pangu.autoSpacingPage()
      })
  }
}

function panguInit () {
  if (false){
    GLOBAL_CONFIG_SITE.isPost && panguFn()
  } else {
    panguFn()
  }
}

document.addEventListener('DOMContentLoaded', panguInit)</script><script src="/js/search/local-search.js"></script><div class="js-pjax"></div><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc@1/dist/activate-power-mode.min.js"></script><script>POWERMODE.colorful = true;
POWERMODE.shake = false;
POWERMODE.mobile = false;
document.body.addEventListener('input', POWERMODE);
</script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></body></html>